<!DOCTYPE html><html class="theme-next pisces" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/uploads/apple-touch-icon.png?v=6.1.0"><link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32.png?v=6.1.0"><link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16.png?v=6.1.0"><link rel="mask-icon" href="/uploads/logo.svg?v=6.1.0" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"6.1.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="FullStack JavaScript Engineer"><meta property="og:type" content="website"><meta property="og:title" content="Micooz"><meta property="og:url" content="https://apporz.com/page/3/index.html"><meta property="og:site_name" content="Micooz"><meta property="og:description" content="FullStack JavaScript Engineer"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Micooz"><meta name="twitter:description" content="FullStack JavaScript Engineer"><link rel="alternate" href="/atom.xml" title="Micooz" type="application/atom+xml"><link rel="canonical" href="https://apporz.com/page/3/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>Micooz</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-72182315-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-72182315-1")</script><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Micooz</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Make something different!</p></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://apporz.com/2015/01/08/cmake-tutorial-translation/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Micooz Lee"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/master.portrait.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Micooz"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2015/01/08/cmake-tutorial-translation/" itemprop="url">CMake官方Tutorial中英对照翻译</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-01-08T00:00:00+08:00">2015-01-08</time> </span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2015/01/08/cmake-tutorial-translation/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/01/08/cmake-tutorial-translation/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="CMake-Tutorial"><a href="#CMake-Tutorial" class="headerlink" title="CMake Tutorial"></a>CMake Tutorial</h1><p>原版英文Tutorial：</p><p><a href="http://www.cmake.org/cmake-tutorial/" target="_blank" rel="noopener">http://www.cmake.org/cmake-tutorial/</a></p><p>Step1-Step7的源代码及CMakeLists：</p><p><a href="http://public.kitware.com/cgi-bin/viewcvs.cgi/CMake/Tests/Tutorial/" target="_blank" rel="noopener">http://public.kitware.com/cgi-bin/viewcvs.cgi/CMake/Tests/Tutorial/</a></p><blockquote><p>Below is a step-by-step tutorial covering common build system issues<br>that CMake helps to address. Many of these topics have been introduced<br>in Mastering CMake as separate issues but seeing how they all work<br>together in an example project can be very helpful. This tutorial can<br>be found in the Tests/Tutorial directory of the CMake source code<br>tree. Each step has its own subdirectory containing a complete copy of<br>the tutorial for that step</p></blockquote><p>下面是涵盖CMake解决常见构建系统问题的一个手把手教程。通过单独的例子，阐述了CMake是如何协同工作的，这将会对你十分有帮助。这个教程可以在CMake源代码树的<code>Test/Tutorial</code>目录下找到。每个步骤有各自的子目录，且包含了一份关于这个步骤的完整教程。</p><h1 id="A-Basic-Starting-Point-Step1-简单的开始"><a href="#A-Basic-Starting-Point-Step1-简单的开始" class="headerlink" title="A Basic Starting Point (Step1)  简单的开始"></a>A Basic Starting Point (Step1) 简单的开始</h1><blockquote><p>The most basic project is an executable built from source code files.<br>For simple projects a two line CMakeLists file is all that is<br>required. This will be the starting point for our tutorial. The<br>CMakeLists file looks like:</p></blockquote><p>最基本的工程是从源代码文件构建出可执行程序。对于简单的工程而言，一个两行的<code>CMakeLists</code>文件已经足够了。这将会是我们教程开始的第一步。<code>CMakeLists</code>文件看起来像这样：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cmake_minimum_required (VERSION 2.6)</span><br><span class="line"></span><br><span class="line">project (Tutorial)</span><br><span class="line"></span><br><span class="line">add_executable(Tutorial tutorial.cxx)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note that this example uses lower case commands in the CMakeLists<br>file. Upper, lower, and mixed case commands are supported by CMake.<br>The source code for tutorial.cxx will compute the square root of a<br>number and the first version of it is very simple, as follows:</p>
</blockquote>
<p>注意到这个例子在<code>CMakeLists</code>中用的是小写命令。无论是大写、小写、还是混合大小写，CMake都支持。<br>源代码文件<code>tutorial.cxx</code>将计算一个数的平方根，第一个版本十分简单：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
// A simple program that computes the square root of a number
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;math.h&gt;

int main (int argc, char *argv[])
{
  if (argc &lt; 2)
    {
    fprintf(stdout,&quot;Usage: %s number\n&quot;,argv[0]);
    return 1;
    }
  double inputValue = atof(argv[1]);
  double outputValue = sqrt(inputValue);
  fprintf(stdout,&quot;The square root of %g is %g\n&quot;,
          inputValue, outputValue);
  return 0;
}
</code></pre><h2 id="Adding-a-Version-Number-and-Configured-Header-File-添加一个版本号和用于配置的头文件"><a href="#Adding-a-Version-Number-and-Configured-Header-File-添加一个版本号和用于配置的头文件" class="headerlink" title="Adding a Version Number and Configured Header File 添加一个版本号和用于配置的头文件"></a>Adding a Version Number and Configured Header File 添加一个版本号和用于配置的头文件</h2><blockquote>
<p>The first feature we will add is to provide our executable and project<br>with a version number. While you can do this exclusively in the source<br>code, doing it in the CMakeLists file provides more flexibility. To<br>add a version number we modify the CMakeLists file as follows:</p>
</blockquote>
<p>我们将为可执行程序和工程提供一个版本号作为第一个特性。当然你可以在源代码中专门这样做，但是使用<code>CMakeLists</code>文件将更加灵活。为了添加一个版本号，我们修改<code>CMakeLists</code>文件如下：</p>
<pre><code>&lt;!-- lang: shell --&gt;
cmake_minimum_required (VERSION 2.6)
project (Tutorial)
# The version number.
set (Tutorial_VERSION_MAJOR 1)
set (Tutorial_VERSION_MINOR 0)

# configure a header file to pass some of the CMake settings
# to the source code
configure_file (
  &quot;${PROJECT_SOURCE_DIR}/TutorialConfig.h.in&quot;
  &quot;${PROJECT_BINARY_DIR}/TutorialConfig.h&quot;
  )

# add the binary tree to the search path for include files
# so that we will find TutorialConfig.h
include_directories(&quot;${PROJECT_BINARY_DIR}&quot;)

# add the executable
add_executable(Tutorial tutorial.cxx)
</code></pre><blockquote>
<p>Since the configured file will be written into the binary tree we must<br>add that directory to the list of paths to search for include files.<br>We then create a TutorialConfig.h.in file in the source tree with the<br>following contents:</p>
</blockquote>
<p>由于配置文件将被写入二进制树，我们必须要在路径列表中添加目录以搜索包含文件。<br>然后我们在源代码树中添加<code>TutorialConfig.h.in</code>文件：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
// the configured options and settings for Tutorial
#define Tutorial_VERSION_MAJOR @Tutorial_VERSION_MAJOR@
#define Tutorial_VERSION_MINOR @Tutorial_VERSION_MINOR@
</code></pre><blockquote>
<p>When CMake configures this header file the values for<br>@Tutorial_VERSION_MAJOR@ and @Tutorial_VERSION_MINOR@ will be replaced<br>by the values from the CMakeLists file. Next we modify tutorial.cxx to<br>include the configured header file and to make use of the version<br>numbers. The resulting source code is listed below.</p>
</blockquote>
<p>CMake在配置过程中，将从<code>CMakeLists</code>文件中找到并替换头文件中的<code>@Tutorial_VERSION_MAJOR@</code>和<code>@Tutorial_VERSION_MINOR@</code>。之后我们修改<code>tutorial.cxx</code>，使它包含配置头文件，然后利用版本号。最终的源代码如下：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
// A simple program that computes the square root of a number
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;math.h&gt;
#include &quot;TutorialConfig.h&quot;

int main (int argc, char *argv[])
{
  if (argc &lt; 2)
    {
    fprintf(stdout,&quot;%s Version %d.%d\n&quot;,
            argv[0],
            Tutorial_VERSION_MAJOR,
            Tutorial_VERSION_MINOR);
    fprintf(stdout,&quot;Usage: %s number\n&quot;,argv[0]);
    return 1;
    }
  double inputValue = atof(argv[1]);
  double outputValue = sqrt(inputValue);
  fprintf(stdout,&quot;The square root of %g is %g\n&quot;,
          inputValue, outputValue);
  return 0;
}
</code></pre><blockquote>
<p>The main changes are the inclusion of the TutorialConfig.h header file<br>and printing out a version number as part of the usage message.</p>
</blockquote>
<p>主要的改变是添加了<code>TutorialConfig.h</code>头文件以及在使用帮助中打印出了版本号。</p>
<h1 id="Adding-a-Library-Step-2-添加一个库"><a href="#Adding-a-Library-Step-2-添加一个库" class="headerlink" title="Adding a Library (Step 2) 添加一个库"></a>Adding a Library (Step 2) 添加一个库</h1><blockquote>
<p>Now we will add a library to our project. This library will contain<br>our own implementation for computing the square root of a number. The<br>executable can then use this library instead of the standard square<br>root function provided by the compiler. For this tutorial we will put<br>the library into a subdirectory called MathFunctions. It will have the<br>following one line CMakeLists file:</p>
</blockquote>
<p>现在我们将为工程添加一个库。这个库将包含计算一个数的平方根的实现代码。可执行程序可以使用这个库，来替代编译器提供的标准平方根函数。在这个教程中，我们将把库放进一个叫做<code>MathFunctions</code>的子目录中。<code>CMakeLists</code>文件将包含这样一行：</p>
<pre><code>&lt;!-- lang: shell --&gt;
add_library(MathFunctions mysqrt.cxx)
</code></pre><blockquote>
<p>The source file mysqrt.cxx has one function called mysqrt that<br>provides similar functionality to the compiler’s sqrt function. To<br>make use of the new library we add an add_subdirectory call in the top<br>level CMakeLists file so that the library will get built. We also add<br>another include directory so that the MathFunctions/mysqrt.h header<br>file can be found for the function prototype. The last change is to<br>add the new library to the executable. The last few lines of the top<br>level CMakeLists file now look like:</p>
</blockquote>
<p>源代码文件<code>mysqrt.cxx</code>有一个叫做<code>mysqrt</code>的函数，提供了一个类似于编译器<code>sqrt</code>函数的功能。为了能利用这个新库，我们在<code>CMakeLists</code>文件的顶部添加一个<code>add_subdirectory</code>调用来使之能够被构建。同时，我们也添加一个包含目录使<code>MathFunctions/mysqrt.h</code>头文件提供函数原型。最后一个改变是给可执行程序添加新库。<code>CMakeLists</code>文件的最后几行看起来像这样：</p>
<pre><code>&lt;!-- lang: shell --&gt;
include_directories (&quot;${PROJECT_SOURCE_DIR}/MathFunctions&quot;)
add_subdirectory (MathFunctions) 

# add the executable
add_executable (Tutorial tutorial.cxx)
target_link_libraries (Tutorial MathFunctions)
</code></pre><blockquote>
<p>Now let us consider making the MathFunctions library optional. In this<br>tutorial there really isn’t any reason to do so, but with larger<br>libraries or libraries that rely on third party code you might want<br>to. The first step is to add an option to the top level CMakeLists<br>file.</p>
</blockquote>
<p>现在让我们考虑使<code>MathFunctions</code>库可选。这个教程中确实没有任何理由这样做，但是对于更大的库或依赖于第三方代码的库来说，你可能更愿意这样做。第一步是在<code>CMakeLists</code>中添加一个选项：</p>
<pre><code>&lt;!-- lang: shell --&gt;
# should we use our own math functions?
option (USE_MYMATH 
        &quot;Use tutorial provided math implementation&quot; ON) 
</code></pre><blockquote>
<p>This will show up in the CMake GUI with a default value of ON that the<br>user can change as desired. This setting will be stored in the cache<br>so that the user does not need to keep setting it each time they run<br>CMake on this project. The next change is to make the build and<br>linking of the MathFunctions library conditional. To do this we change<br>the end of the top level CMakeLists file to look like the following:</p>
</blockquote>
<p>这将在<code>CMake GUI</code>中默认显示为ON，这样使用者可以根据需要来改变它。这个配置将被保存在缓存中，这样使用者不必在工程中使用CMake时每次都去配置它。下一个改变是使构建和链接<code>MathFunctions</code>库有条件化。为了达到目的我们改变<code>CMakeLists</code>文件如下：</p>
<pre><code>&lt;!-- lang: shell --&gt;
# add the MathFunctions library?
#
if (USE_MYMATH)
  include_directories (&quot;${PROJECT_SOURCE_DIR}/MathFunctions&quot;)
  add_subdirectory (MathFunctions)
  set (EXTRA_LIBS ${EXTRA_LIBS} MathFunctions)
endif (USE_MYMATH)

# add the executable
add_executable (Tutorial tutorial.cxx)
target_link_libraries (Tutorial  ${EXTRA_LIBS})
</code></pre><blockquote>
<p>This uses the setting of USE_MYMATH to determine if the MathFunctions<br>should be compiled and used. Note the use of a variable (EXTRA_LIBS in<br>this case) to collect up any optional libraries to later be linked<br>into the executable. This is a common approach used to keep larger<br>projects with many optional components clean. The corresponding<br>changes to the source code are fairly straight forward and leave us<br>with:</p>
</blockquote>
<p>它使用了<code>USE_MYMATH</code>设置来决定<code>MathFunctions</code>是否应该被编译和使用。注意变量<code>EXTRA_LIBS</code>（本例中）用来收集接下来将被链接到可执行程序中的可选库。这是一个保持大型工程和许多可选组件干净的常用方法。在源代码中的相应改变非常简单：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
// A simple program that computes the square root of a number
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;math.h&gt;
#include &quot;TutorialConfig.h&quot;
#ifdef USE_MYMATH
#include &quot;MathFunctions.h&quot;
#endif

int main (int argc, char *argv[])
{
  if (argc &lt; 2)
    {
    fprintf(stdout,&quot;%s Version %d.%d\n&quot;, argv[0],
            Tutorial_VERSION_MAJOR,
            Tutorial_VERSION_MINOR);
    fprintf(stdout,&quot;Usage: %s number\n&quot;,argv[0]);
    return 1;
    }

  double inputValue = atof(argv[1]);

#ifdef USE_MYMATH
  double outputValue = mysqrt(inputValue);
#else
  double outputValue = sqrt(inputValue);
#endif

  fprintf(stdout,&quot;The square root of %g is %g\n&quot;,
          inputValue, outputValue);
  return 0;
}
</code></pre><blockquote>
<p>In the source code we make use of USE_MYMATH as well. This is provided<br>from CMake to the source code through the TutorialConfig.h.in<br>configured file by adding the following line to it:</p>
</blockquote>
<p>在源代码中我们利用了<code>USE_MYMATH</code>。它是由<code>TutorialConfig.h.in</code>文件通过CMake提供的：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
#cmakedefine USE_MYMATH
</code></pre><h1 id="Installing-and-Testing-Step-3-安装和测试"><a href="#Installing-and-Testing-Step-3-安装和测试" class="headerlink" title="Installing and Testing (Step 3) 安装和测试"></a>Installing and Testing (Step 3) 安装和测试</h1><blockquote>
<p>For the next step we will add install rules and testing support to our<br>project. The install rules are fairly straight forward. For the<br>MathFunctions library we setup the library and the header file to be<br>installed by adding the following two lines to MathFunctions’<br>CMakeLists file:</p>
</blockquote>
<p>下一步我们将给工程添加安装规则和测试支持。安装规则相当简单。</p>
<p>对于<code>MathFunctions</code>库，我们通过在<code>MathFunction</code>的<code>CMakeLists</code>文件中添加下面两行，来使它的库和头文件可以被安装：</p>
<pre><code>&lt;!-- lang: shell --&gt;
install (TARGETS MathFunctions DESTINATION bin)
install (FILES MathFunctions.h DESTINATION include)
</code></pre><blockquote>
<p>For the application the following lines are added to the top level<br>CMakeLists file to install the executable and the configured header<br>file:</p>
</blockquote>
<p>对于应用程序，在<code>CMakeLists</code>中添加下面的命令来安装可执行程序和配置文件：</p>
<pre><code>&lt;!-- lang: shell --&gt;
# add the install targets
install (TARGETS Tutorial DESTINATION bin)
install (FILES &quot;${PROJECT_BINARY_DIR}/TutorialConfig.h&quot;        
         DESTINATION include)
</code></pre><blockquote>
<p>That is all there is to it. At this point you should be able to build<br>the tutorial, then type make install (or build the INSTALL target from<br>an IDE) and it will install the appropriate header files, libraries,<br>and executables. The CMake variable CMAKE_INSTALL_PREFIX is used to<br>determine the root of where the files will be installed. Adding<br>testing is also a fairly straight forward process. At the end of the<br>top level CMakeLists file we can add a number of basic tests to verify<br>that the application is working correctly.</p>
</blockquote>
<p>就是这么一回事，现在你能够构建这个教程了，然后执行<code>make install</code>（或者通过IDE构建INSTALL目标），它将安装适当的头文件，库和可执行程序。CMake变量<code>CMAKE_INSTALL_PREFIX</code>用来决定所安装文件的根目录。</p>
<p>添加测试也非常简单。在顶级<code>CMakeLists</code>文件的最后，我们可以添加一系列基础测试来验证应用程序是否运行正常。</p>
<pre><code>&lt;!-- lang: shell --&gt;
# does the application run
add_test (TutorialRuns Tutorial 25)

# does it sqrt of 25
add_test (TutorialComp25 Tutorial 25)

set_tests_properties (TutorialComp25 
  PROPERTIES PASS_REGULAR_EXPRESSION &quot;25 is 5&quot;)

# does it handle negative numbers
add_test (TutorialNegative Tutorial -25)
set_tests_properties (TutorialNegative
  PROPERTIES PASS_REGULAR_EXPRESSION &quot;-25 is 0&quot;)

# does it handle small numbers
add_test (TutorialSmall Tutorial 0.0001)
set_tests_properties (TutorialSmall
  PROPERTIES PASS_REGULAR_EXPRESSION &quot;0.0001 is 0.01&quot;)

# does the usage message work?
add_test (TutorialUsage Tutorial)
set_tests_properties (TutorialUsage
  PROPERTIES 
  PASS_REGULAR_EXPRESSION &quot;Usage:.*number&quot;)
</code></pre><blockquote>
<p>The first test simply verifies that the application runs, does not<br>segfault or otherwise crash, and has a zero return value. This is the<br>basic form of a CTest test. The next few tests all make use of the<br>PASS_REGULAR_EXPRESSION test property to verify that the output of the<br>test contains certain strings. In this case verifying that the<br>computed square root is what it should be and that the usage message<br>is printed when an incorrect number of arguments are provided. If you<br>wanted to add a lot of tests to test different input values you might<br>consider creating a macro like the following:</p>
</blockquote>
<p>第一个测试例子验证了程序运行，是否出现段错误或者崩溃，是否返回0值。这是一个<code>CTest</code>的基本测试。接下来的几个测试都利用了<code>PASS_REGULAR_EXPRESSION</code>来验证输出是否包含指定的字符串。在这种情况下，验证计算平方根是必要的，当提供了一个错误的参数时就打印用法信息。如果你想添加测试多个不同的输入值，可以考虑写一个像下面这样的宏：</p>
<pre><code>&lt;!-- lang: shell --&gt;
#define a macro to simplify adding tests, then use it
macro (do_test arg result)
  add_test (TutorialComp${arg} Tutorial ${arg})
  set_tests_properties (TutorialComp${arg}
    PROPERTIES PASS_REGULAR_EXPRESSION ${result})
endmacro (do_test)

# do a bunch of result based tests
do_test (25 &quot;25 is 5&quot;)
do_test (-25 &quot;-25 is 0&quot;)
</code></pre><blockquote>
<p>For each invocation of do_test, another test is added to the project<br>with a name, input, and results based on the passed arguments.</p>
</blockquote>
<p>对于每个<code>do_test</code>调用，都会根据传入其中的参数，在工程中添加名称、输入和结果。</p>
<h1 id="Adding-System-Introspection-Step-4-添加系统反馈"><a href="#Adding-System-Introspection-Step-4-添加系统反馈" class="headerlink" title="Adding System Introspection (Step 4) 添加系统反馈"></a>Adding System Introspection (Step 4) 添加系统反馈</h1><blockquote>
<p>Next let us consider adding some code to our project that depends on<br>features the target platform may not have. For this example we will<br>add some code that depends on whether or not the target platform has<br>the log and exp functions. Of course almost every platform has these<br>functions but for this tutorial assume that they are less common. If<br>the platform has log then we will use that to compute the square root<br>in the mysqrt function. We first test for the availability of these<br>functions using the CheckFunctionExists.cmake macro in the top level<br>CMakeLists file as follows:</p>
</blockquote>
<p>接下来让我们考虑在工程中添加一些代码，依赖目标平台上可能没有的特性。在这个例子中，我们将添加一些依赖于目标平台是否存在<code>log</code>和<code>exp</code>函数的代码。当然几乎所有的平台都有这些函数，但这个教程假设它们（这些函数）不常见。如果平台存在<code>log</code>，我们就在<code>mysqrt</code>中使用它来计算平方根。我们首先在顶级<code>CMakeLists</code>中使用<code>CheckFunctionExists.cmake</code>宏来测试这些函数的可用性：</p>
<pre><code>&lt;!-- lang: shell --&gt;
# does this system provide the log and exp functions?
include (CheckFunctionExists.cmake)
check_function_exists (log HAVE_LOG)
check_function_exists (exp HAVE_EXP)
</code></pre><blockquote>
<p>Next we modify the TutorialConfig.h.in to define those values if CMake<br>found them on the platform as follows:</p>
</blockquote>
<p>接下来我们修改<code>TutorialConfig.h.in</code>，如果CMake在平台上找到他们（函数），就定义这些值：</p>
<pre><code>&lt;!-- lang: shell --&gt;
// does the platform provide exp and log functions?
#cmakedefine HAVE_LOG
#cmakedefine HAVE_EXP
</code></pre><blockquote>
<p>It is important that the tests for log and exp are done before the<br>configure_file command for TutorialConfig.h. The configure_file<br>command immediately configures the file using the current settings in<br>CMake. Finally in the mysqrt function we can provide an alternate<br>implementation based on log and exp if they are available on the<br>system using the following code:</p>
</blockquote>
<p>在为<code>TutorialConfig.h</code>执行<code>configure_file</code>命令之前完成对<code>log</code>和<code>exp</code>的测试非常重要。<code>configure_file</code>命令会使用CMake的当前设置立即配置这个文件。最后我们可以在<code>mysqrt</code>函数中提供基于<code>log</code>和<code>exp</code>的可选实现（如果他们在当前系统上可用）：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
// if we have both log and exp then use them
#if defined (HAVE_LOG) &amp;&amp; defined (HAVE_EXP)
  result = exp(log(x)*0.5);
#else // otherwise use an iterative approach
  . . .
</code></pre><h1 id="Adding-a-Generated-File-and-Generator-Step-5-添加生成的文件和生成器"><a href="#Adding-a-Generated-File-and-Generator-Step-5-添加生成的文件和生成器" class="headerlink" title="Adding a Generated File and Generator (Step 5) 添加生成的文件和生成器"></a>Adding a Generated File and Generator (Step 5) 添加生成的文件和生成器</h1><blockquote>
<p>In this section we will show how you can add a generated source file<br>into the build process of an application. For this example we will<br>create a table of precomputed square roots as part of the build<br>process, and then compile that table into our application. To<br>accomplish this we first need a program that will generate the table.<br>In the MathFunctions subdirectory a new source file named<br>MakeTable.cxx will do just that.</p>
</blockquote>
<p>在这个单元中我们将为你展示如何在应用程序的构建过程中添加生成好的源文件。这个例子中我们将为构建过程造一个预计算平方根的表，然后将这个表编译进我们的应用程序。为了完成这个，我们首先需要一个可以生成这个表的程序。<code>MathFunctions</code>子目录下的<code>MakeTable.cxx</code>新源文件将完成这个工作：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
// A simple program that builds a sqrt table 
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;math.h&gt;

int main (int argc, char *argv[])
{
  int i;
  double result;

  // make sure we have enough arguments
  if (argc &lt; 2)
    {
    return 1;
    }

  // open the output file
  FILE *fout = fopen(argv[1],&quot;w&quot;);
  if (!fout)
    {
    return 1;
    }

  // create a source file with a table of square roots
  fprintf(fout,&quot;double sqrtTable[] = {\n&quot;);
  for (i = 0; i &lt; 10; ++i)
    {
    result = sqrt(static_cast&lt;double&gt;(i));
    fprintf(fout,&quot;%g,\n&quot;,result);
    }

  // close the table with a zero
  fprintf(fout,&quot;0};\n&quot;);
  fclose(fout);
  return 0;
}
</code></pre><blockquote>
<p>Note that the table is produced as valid C++ code and that the name of<br>the file to write the output to is passed in as an argument. The next<br>step is to add the appropriate commands to MathFunctions’ CMakeLists<br>file to build the MakeTable executable, and then run it as part of the<br>build process. A few commands are needed to accomplish this, as shown<br>below.</p>
</blockquote>
<p>注意这个表格由C++代码产生，文件名作为参数传入以在里面输出结果。下一步是给<code>MathFunctions</code>的<code>CMakeLists</code>添加适当的命令来构建<code>MakeTable</code>程序。之后将作为构建过程的一部分来运行。需要很少的命令来完成这件事：</p>
<pre><code>&lt;!-- lang: shell --&gt;
# first we add the executable that generates the table
add_executable(MakeTable MakeTable.cxx)

# add the command to generate the source code
add_custom_command (
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/Table.h
  COMMAND MakeTable ${CMAKE_CURRENT_BINARY_DIR}/Table.h
  DEPENDS MakeTable
  )

# add the binary tree directory to the search path for 
# include files
include_directories( ${CMAKE_CURRENT_BINARY_DIR} )

# add the main library
add_library(MathFunctions mysqrt.cxx ${CMAKE_CURRENT_BINARY_DIR}/Table.h  )
</code></pre><blockquote>
<p>First the executable for MakeTable is added as any other executable<br>would be added. Then we add a custom command that specifies how to<br>produce Table.h by running MakeTable. Next we have to let CMake know<br>that mysqrt.cxx depends on the generated file Table.h. This is done by<br>adding the generated Table.h to the list of sources for the library<br>MathFunctions. We also have to add the current binary directory to the<br>list of include directories so that Table.h can be found and included<br>by mysqrt.cxx. When this project is built it will first build the<br>MakeTable executable. It will then run MakeTable to produce Table.h.<br>Finally, it will compile mysqrt.cxx which includes Table.h to produce<br>the MathFunctions library. At this point the top level CMakeLists file<br>with all the features we have added looks like the following:</p>
</blockquote>
<p>首先，<code>MakeTable</code>像其他任何一个可执行程序一样被添加进入。然后，我们添加一个定制的命令来指定如何运行<code>MakeTable</code>来产生<code>Table.h</code>。之后，我们必须让CMake知道<code>mysqrt.cxx</code>依赖生成的<code>Table.h</code>文件。将生成的<code>Table.h</code>添加到<code>MathFunctions</code>源代码列表中来搞定它。同时我们也必须将当前二进制目录添加到包含目录列表中，使得<code>Table.h</code>可以被找到，以及被<code>mysqrt.cxx</code>包含。</p>
<p>但工程开始构建时，他首先会构建<code>MakeTable</code>程序，然后执行<code>MakeTable</code>来产生<code>Table.h</code>。最后，他会编译包含了<code>Table.h</code>的<code>mysqrt.cxx</code>来生成<code>MathFunctions</code>库。</p>
<p>至此，顶层的CMakeLists文件包含了我们之前添加的所有特性：</p>
<pre><code>&lt;!-- lang: shell --&gt;
cmake_minimum_required (VERSION 2.6)
project (Tutorial)

# The version number.
set (Tutorial_VERSION_MAJOR 1)
set (Tutorial_VERSION_MINOR 0)

# does this system provide the log and exp functions?
include (${CMAKE_ROOT}/Modules/CheckFunctionExists.cmake)

check_function_exists (log HAVE_LOG)
check_function_exists (exp HAVE_EXP)

# should we use our own math functions
option(USE_MYMATH 
  &quot;Use tutorial provided math implementation&quot; ON)

# configure a header file to pass some of the CMake settings
# to the source code
configure_file (
  &quot;${PROJECT_SOURCE_DIR}/TutorialConfig.h.in&quot;
  &quot;${PROJECT_BINARY_DIR}/TutorialConfig.h&quot;
  )

# add the binary tree to the search path for include files
# so that we will find TutorialConfig.h
include_directories (&quot;${PROJECT_BINARY_DIR}&quot;)

# add the MathFunctions library?
if (USE_MYMATH)
  include_directories (&quot;${PROJECT_SOURCE_DIR}/MathFunctions&quot;)
  add_subdirectory (MathFunctions)
  set (EXTRA_LIBS ${EXTRA_LIBS} MathFunctions)
endif (USE_MYMATH)

# add the executable
add_executable (Tutorial tutorial.cxx)
target_link_libraries (Tutorial  ${EXTRA_LIBS})

# add the install targets
install (TARGETS Tutorial DESTINATION bin)
install (FILES &quot;${PROJECT_BINARY_DIR}/TutorialConfig.h&quot;        
         DESTINATION include)

# does the application run
add_test (TutorialRuns Tutorial 25)

# does the usage message work?
add_test (TutorialUsage Tutorial)
set_tests_properties (TutorialUsage
  PROPERTIES 
  PASS_REGULAR_EXPRESSION &quot;Usage:.*number&quot;
  )


#define a macro to simplify adding tests
macro (do_test arg result)
  add_test (TutorialComp${arg} Tutorial ${arg})
  set_tests_properties (TutorialComp${arg}
    PROPERTIES PASS_REGULAR_EXPRESSION ${result}
    )
endmacro (do_test)

# do a bunch of result based tests
do_test (4 &quot;4 is 2&quot;)
do_test (9 &quot;9 is 3&quot;)
do_test (5 &quot;5 is 2.236&quot;)
do_test (7 &quot;7 is 2.645&quot;)
do_test (25 &quot;25 is 5&quot;)
do_test (-25 &quot;-25 is 0&quot;)
do_test (0.0001 &quot;0.0001 is 0.01&quot;)
</code></pre><blockquote>
<p>TutorialConfig.h looks like:</p>
</blockquote>
<p><code>TutorialConfig.h</code>如下：</p>
<pre><code>&lt;!-- lang: cpp --&gt;
// the configured options and settings for Tutorial
#define Tutorial_VERSION_MAJOR @Tutorial_VERSION_MAJOR@
#define Tutorial_VERSION_MINOR @Tutorial_VERSION_MINOR@
#cmakedefine USE_MYMATH

// does the platform provide exp and log functions?
#cmakedefine HAVE_LOG
#cmakedefine HAVE_EXP
</code></pre><blockquote>
<p>And the CMakeLists file for MathFunctions looks like:</p>
</blockquote>
<p><code>MathFunctions</code>的<code>CMakeLists</code>如下：</p>
<pre><code>&lt;!-- lang: shell --&gt;
# first we add the executable that generates the table
add_executable(MakeTable MakeTable.cxx)
# add the command to generate the source code
add_custom_command (
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/Table.h
  DEPENDS MakeTable
  COMMAND MakeTable ${CMAKE_CURRENT_BINARY_DIR}/Table.h
  )
# add the binary tree directory to the search path 
# for include files
include_directories( ${CMAKE_CURRENT_BINARY_DIR} )

# add the main library
add_library(MathFunctions mysqrt.cxx ${CMAKE_CURRENT_BINARY_DIR}/Table.h)

install (TARGETS MathFunctions DESTINATION bin)
install (FILES MathFunctions.h DESTINATION include)
</code></pre><h1 id="Building-an-Installer-Step-6-构建一个安装程序"><a href="#Building-an-Installer-Step-6-构建一个安装程序" class="headerlink" title="Building an Installer (Step 6) 构建一个安装程序"></a>Building an Installer (Step 6) 构建一个安装程序</h1><blockquote>
<p>Next suppose that we want to distribute our project to other people so<br>that they can use it. We want to provide both binary and source<br>distributions on a variety of platforms. This is a little different<br>from the instal we did previously in section Installing and Testing<br>(Step 3), where we were installing the binaries that we had built from<br>the source code. In this example we will be building installation<br>packages that support binary installations and package management<br>features as found in cygwin, debian, RPMs etc. To accomplish this we<br>will use CPack to create platform specific installers as described in<br>Chapter Packaging with CPack. Specifically we need to add a few lines<br>to the bottom of our toplevel CMakeLists.txt file.</p>
</blockquote>
<p>下面假设我们想发布我们的工程给其他人使用。我们想同时在多个平台上提供二进制程序和源代码。这和我们之前在第三部分<code>Installing and Testing</code>中做的安装（从源代码构建安装）有一点不同。这个例子中，我们将构建一个支持二进制安装和包管理特性的安装包，就像在<code>cygwin</code>、<code>debian</code>、<code>RPM</code>中找到的安装包一样。为了完成这件事，我们将利用在章节<code>Packaging with CPack</code>提到的<code>CPack</code>制作指定平台的安装程序。特别地，我们需要在顶层<code>CMakeLists</code>下面添加几行：</p>
<pre><code>&lt;!-- lang: shell --&gt;
# build a CPack driven installer package
include (InstallRequiredSystemLibraries)
set (CPACK_RESOURCE_FILE_LICENSE  
     &quot;${CMAKE_CURRENT_SOURCE_DIR}/License.txt&quot;)
set (CPACK_PACKAGE_VERSION_MAJOR &quot;${Tutorial_VERSION_MAJOR}&quot;)
set (CPACK_PACKAGE_VERSION_MINOR &quot;${Tutorial_VERSION_MINOR}&quot;)
include (CPack)
</code></pre><blockquote>
<p>That is all there is to it. We start by including<br>InstallRequiredSystemLibraries. This module will include any runtime<br>libraries that are needed by the project for the current platform.<br>Next we set some CPack variables to where we have stored the license<br>and version information for this project. The version information<br>makes use of the variables we set earlier in this tutorial. Finally we<br>include the CPack module which will use these variables and some other<br>properties of the system you are on to setup an installer. The next<br>step is to build the project in the usual manner and then run CPack on<br>it. To build a binary distribution you would run:</p>
</blockquote>
<p>就是这样，先包含<code>InstallRequiredSystemLibraries</code>。这个模块将包含工程在当前平台需要的任何运行库。然后，我们设置一些<code>CPack</code>变量指向工程存放<code>license</code>和<code>version</code>信息的地方。版本信息利用了我们之前在教程里设置的变量。最后，我们包含的<code>CPack</code>模块将会使用这些变量，以及你所在系统的其他一些属性，来制作一个安装包。</p>
<p>下一步是按照平常的方式构建工程然后启动<code>CPack</code>。要发布一个二进制版，你需要执行：</p>
<pre><code>&lt;!-- lang: shell --&gt;
cpack -C CPackConfig.cmake
</code></pre><blockquote>
<p>To create a source distribution you would type</p>
</blockquote>
<p>要发布源代码，你需要执行：</p>
<pre><code>&lt;!-- lang: shell --&gt;
cpack -C CPackSourceConfig.cmake
</code></pre><h1 id="Adding-Support-for-a-Dashboard-Step-7-添加面板支持"><a href="#Adding-Support-for-a-Dashboard-Step-7-添加面板支持" class="headerlink" title="Adding Support for a Dashboard (Step 7)  添加面板支持"></a>Adding Support for a Dashboard (Step 7)  添加面板支持</h1><blockquote>
<p>Adding support for submitting our test results to a dashboard is very<br>easy. We already defined a number of tests for our project in the<br>earlier steps of this tutorial. We just have to run those tests and<br>submit them to a dashboard. To include support for dashboards we<br>include the CTest module in our toplevel CMakeLists file.</p>
</blockquote>
<p>为提交我们的测试结果添加面板支持十分简单。在之前的教程中，我们已经为工程定义了很多测试。我们仅仅需要执行这些测试以及把它们提交到面板。要包含面板支持我们需要在顶层<code>CMakeLists</code>中包含<code>CTest</code>模块。</p>
<pre><code>&lt;!-- lang: shell --&gt;
# enable dashboard scripting
include (CTest)
</code></pre><blockquote>
<p>We also create a CTestConfig.cmake file where we can specify the name<br>of this project for the dashboard.</p>
</blockquote>
<p>我们还为面板写了一个可以指定工程名的<code>CTestConfig.cmake</code>文件。</p>
<pre><code>&lt;!-- lang: shell --&gt;
set (CTEST_PROJECT_NAME &quot;Tutorial&quot;)
</code></pre><blockquote>
<p>CTest will read in this file when it runs. To create a simple<br>dashboard you can run CMake on your project, change directory to the<br>binary tree, and then run ctest –D Experimental. The results of your<br>dashboard will be uploaded to Kitware’s public dashboard here.</p>
</blockquote>
<p><code>CTest</code>将在运行时读取这个文件。要创建一个简单的面板，你可以在你的工程里运行CMake，将目录改变到二进制树，然后执行实验性的<code>ctest -D</code>。你面板上的结果将会被上传到<code>Kitware</code>的<a href="http://www.cdash.org/CDash/index.php?project=PublicDashboard" target="_blank" rel="noopener">公开面板</a>。</p>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>由于本人水平所限，译文和原文内容难免存在差异，甚至错误，还请各位读者评批指出！谢谢！</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2015/01/02/cpp-encoding-problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/01/02/cpp-encoding-problem/" itemprop="url">
                  C++ 字符编码问题探究和中文乱码的产生
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-01-02T00:00:00+08:00">2015-01-02</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/01/02/cpp-encoding-problem/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/01/02/cpp-encoding-problem/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>一直以来，C/C++对中文字符的处理时常让人摸不着头脑。</p><p>主要有下面几个原因：</p><ol><li><p>文件编码方式的差异</p></li><li><p>系统环境对中文的解释有差异</p></li><li><p>不同编译器对标准库的实现有差异</p></li></ol><p>而这三者往往又相互影响，暗藏玄机，让人抓狂。</p><p>在写本文之前我查阅了很多博客，关于中文的输入输出，cout，wcout，fstream，wfstream，乱码解决方案等等问题都有了十分详细的解答，但是，很多博文具有片面性。</p><p>许多博主仅仅是针对自己所使用的环境做阐述，而又没有明确指明使用了何种IDE，何种编译器，何种系统。结果就是，博主们高高兴兴的解决的自己的问题并分享出来，大家高高兴兴的点赞，觉得自己和博主的问题是同一个问题，实际情况却大相径庭。</p><h1 id="必要的说明"><a href="#必要的说明" class="headerlink" title="必要的说明"></a>必要的说明</h1><p>文本涉及的编译器和系统：</p><ul><li><p>msvc v120 Windows 8.1</p></li><li><p>mingw 4.8 32bit Windows 8.1</p></li><li><p>g++ 4.8.2 Linux 64bit</p></li></ul><h1 id="开始测试"><a href="#开始测试" class="headerlink" title="开始测试"></a>开始测试</h1><p>测试之前很有必要说明一点：</p><blockquote><p>A program should not mix output operations on wcout with output operations on cout (or with other narrow-oriented output operations on stdout): Once an output operation has been performed on either, the standard output stream acquires an orientation (either narrow or wide) that can only be safely changed by calling freopen on stdout.<br>—- cplusplus.com</p></blockquote><p>就是说不要混用cout和wcout进行输出，因此下面的例子中都是单独使用cout或者wcout。</p><h2 id="cout测试"><a href="#cout测试" class="headerlink" title="cout测试"></a>cout测试</h2><p><em>下面的测试在Visual Studio 2013中进行。</em></p><h3 id="MSVC，默认编码GB2312（可以在-文件–高级保存选项-中查看和修改）"><a href="#MSVC，默认编码GB2312（可以在-文件–高级保存选项-中查看和修改）" class="headerlink" title="MSVC，默认编码GB2312（可以在 文件–高级保存选项 中查看和修改）"></a>MSVC，默认编码GB2312（可以在 <strong>文件–高级保存选项</strong> 中查看和修改）</h3><pre><code>&lt;!-- lang: cpp --&gt;
#include &lt;iostream&gt;

int main() {
    using namespace std;

    const char *code = &quot;abc中文def&quot;;

    cout &lt;&lt; &quot;abc中文def&quot; &lt;&lt; endl;
    cout &lt;&lt; code &lt;&lt; endl;

    return 0;
}
</code></pre><p><strong>结果</strong></p><blockquote><p>abc中文def</p><p>abc中文def</p></blockquote><p>均正确输出。</p><h3 id="MSVC，改变编码为UTF8（-bom）"><a href="#MSVC，改变编码为UTF8（-bom）" class="headerlink" title="MSVC，改变编码为UTF8（+bom）"></a>MSVC，改变编码为UTF8（+bom）</h3><p><strong>结果</strong></p><blockquote><p>abc中文def</p><p>abc中文def</p></blockquote><p>均正确输出。</p><h3 id="MSVC，改变编码为UTF8（-bom）-1"><a href="#MSVC，改变编码为UTF8（-bom）-1" class="headerlink" title="MSVC，改变编码为UTF8（-bom）"></a>MSVC，改变编码为UTF8（-bom）</h3><p><strong>结果</strong></p><blockquote><p>abc涓枃def</p><p>abc涓枃def</p></blockquote><p>出现乱码。</p><h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>可以看到源文件的编码方式会影响最后的输出，原因在于常量文本采用了<strong>硬编码</strong>的方式，也就是说源代码里面的中文会根据当前文件的编码方式直接翻译成对应字节码放进存储空间。</p><p>如“中文”二字，</p><p><strong>GB2312</strong>（Codepage 936）的编码为：</p><p>D6 D0 CE C4</p><p>而<strong>UTF8</strong>是：</p><p>E4 B8 AD E6 96 87</p><p>而控制台也有一套编码方式，对于Windows的cmd，可以查看其 <strong>属性</strong> 下面的当前代码页，笔者是ANSI(936)。</p><p>当向控制台传送GB2312的字节码时，中文显示正常，当传入无签名的UTF8的字节码时，中文就不能被正确解释，出现了乱码。</p><p>Q：为什么带有签名的UTF8却可以正常显示呢？</p><p>A：实际上UTF8完全不需要带签名，M$自作聪明YY了一个bom头来识别文件是不是UTF8。因此带有签名的UTF8能被cmd识别为UTF8，中文才能显示正常。</p><p>为了进一步证实是不是和控制台的编码有关系，并正确理解上一个例子中乱码的产生缘由，我们可以做一个重定向，将结果输出到文本文件：</p><blockquote><p>test.exe &gt; test.txt</p></blockquote><p>使用任意可以改变编码的文本编辑器（笔者使用的是everedit）查看，可以发现以UTF8解释，显示正常，以ANSI(936)解释，将得到刚才那个乱码。</p><hr><p><em>下面的测试在QtCreator中进行。</em></p><h3 id="MinGW，UTF8"><a href="#MinGW，UTF8" class="headerlink" title="MinGW，UTF8"></a>MinGW，UTF8</h3><p><strong>结果</strong></p><blockquote><p>abc涓枃def</p><p>abc涓枃def</p></blockquote><p>出现乱码。</p><h3 id="MinGW，ANSI-936"><a href="#MinGW，ANSI-936" class="headerlink" title="MinGW，ANSI-936"></a>MinGW，ANSI-936</h3><p><strong>结果</strong></p><blockquote><p>abc中文def</p><p>abc中文def</p></blockquote><p>显示正确。</p><hr><p><em>下面的测试在Linux的bash中进行。</em></p><h3 id="g-，UTF8"><a href="#g-，UTF8" class="headerlink" title="g++，UTF8"></a>g++，UTF8</h3><p><strong>结果</strong></p><blockquote><p>abc中文def</p><p>abc中文def</p></blockquote><p>显示正确。</p><h3 id="g-，gb2312"><a href="#g-，gb2312" class="headerlink" title="g++，gb2312"></a>g++，gb2312</h3><p><strong>结果</strong></p><blockquote><p>abc▒▒▒▒def</p><p>abc▒▒▒▒def</p></blockquote><p>出现乱码。</p><p>Ubuntu查看/etc/default/locale，可以看到LANG=”en_US.UTF-8”，说明bash能解释UTF8的字节码，而gb2312的变成了乱码。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>程序的输出编码必须和”显示程序”的显示编码适配时才能得到正确的结果。简而言之就是<strong>解铃还须系铃人</strong>。</p><hr><p>宽字符使用多个字节来表示一个字符，中文可以用char来表示没问题，用wchar来表示也没有问题。</p><h2 id="wcout测试"><a href="#wcout测试" class="headerlink" title="wcout测试"></a>wcout测试</h2><p>wcout输出wchar_t型的宽字符，测试代码如下：</p><pre><code>&lt;!-- lang: cpp --&gt;
#include &lt;iostream&gt;

int main() {
    using namespace std;

    const wchar_t *code = L&quot;abc中文def&quot;;

    wcout &lt;&lt; L&quot;abc中文def&quot; &lt;&lt; endl;
    wcout &lt;&lt; code &lt;&lt; endl;

    return 0;
}
</code></pre><h3 id="MSVC，无论上述何种编码"><a href="#MSVC，无论上述何种编码" class="headerlink" title="MSVC，无论上述何种编码"></a>MSVC，无论上述何种编码</h3><p><strong>结果</strong></p><p>abc</p><p>输出被截断，只有前几个英文字母可以被输出，传入指针输出无效。</p><h3 id="问题分析-1"><a href="#问题分析-1" class="headerlink" title="问题分析"></a>问题分析</h3><p><strong>L”abc中文def”</strong> 在内存中表现为：</p><blockquote><p>(gb2312) 61 00 62 00 63 00 <strong>2d 4e 87 65</strong> 64 00 65 00 66 00</p></blockquote><blockquote><p>(utf8-bom) 61 00 62 00 63 00 <strong>2d 4e 87 65</strong> 64 00 65 00 66 00</p></blockquote><blockquote><p>(utf8+bom)61 00 62 00 63 00 <strong>93 6d 5f e1 83 67</strong> 64 00 65 00 66 00</p></blockquote><p>wcout 在处理L”abc中文def”时，按宽字节依次遍历，前面的abc没问题（小端序第一个字节是00），遇到中文，识别不了，无输出，间接导致后续&lt;&lt;都没有输出了。</p><p>也就是说wcout不能用来处理中文输出。</p><p>第二个传入wchar_t指针，发现没有任何输出，为了验证是不是由于上一条输出语句中中文的影响，单独测试如下：</p><pre><code>&lt;!-- lang: cpp --&gt;
#include &lt;iostream&gt;

int main() {
    using namespace std;

    const wchar_t *code = L&quot;abc中文def&quot;;

    wcout &lt;&lt; code &lt;&lt; endl;

    return 0;
}
</code></pre><p><strong>结果</strong></p><p>abc</p><p>说明传入wchar_t指针是可以正常输出宽字节英文的，一旦遇到非00字节间隔，后续所有输出将无效。</p><p>MinGW的结果同样如此，无论编码与否，只要wcout遇到中文立马跪。</p><p>有博主称可以在输出前执行下面的函数或者进行全局设置来让wcout认识中文：</p><pre><code>&lt;!-- lang: cpp --&gt;
std::wcout.imbue(std::locale(&quot;chs&quot;));
std::locale::global(std::locale(&quot;&quot;));//全局设置
</code></pre><ul><li><p>MSVC下，没有问题，可以达到预期结果。</p></li><li><p>MinGW下，第一条语句会抛出一个runtime_error异常崩溃掉，第二条语句无效。</p></li><li><p>Linux g++下，没问题。</p></li></ul><p>可见MinGW的libstdc++对locale的实现不理想，有传闻使用stlport可以避免这个问题。</p><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul><li><p>认清你的代码处在何种编码的环境</p></li><li><p>认清放在你字符串里面的数据是何种编码</p></li><li><p>认清你要向具有何种编码的屏幕传送数据</p></li><li><p>解铃还须系铃人</p></li><li><p>非特殊情况下不建议使用wchar_t来存放中文字符</p></li></ul><p>很多时候中文并不是硬编码进程序的，例如一段中文来自网络，以gb2312编码，而”屏幕”只认UTF8，这个时候就要进行必要的编码转换。boost库的boost::locale::conv中提供了很多常用的转换模板函数，来实现宽窄字符、ansi和utf之间的相互转换。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/10/01/cpp-ntp-client-using-boost/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/01/cpp-ntp-client-using-boost/" itemprop="url">
                  C++使用Boost实现Network Time Protocol(NTP)客户端
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-10-01T00:00:00+08:00">2014-10-01</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/10/01/cpp-ntp-client-using-boost/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/10/01/cpp-ntp-client-using-boost/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>笔者机器上安装了两个系统，一个Linux Ubuntu，一个Windows8.1。让人感到郁闷的是，每次从Ubuntu重启进入Windows时，系统时间总是少了8个小时，每次都要用Windows的时间程序进行同步，也就是下面这个东西：</p><p><img src="103314_axWa_580940.png" alt=""></p><p>这个东西其实就是一个NTP Client，从Internet上选择一台NTP Server，获取UTC时间，然后设置本地时间。</p><p>于是我想自己实现一个这样的程序，先百度一下吧，网上有很多关于NTP的资料和实现代码，大多是单一平台的，不能跨平台</p><p>，下面给几个参考：</p><p><a href="http://blog.csdn.net/loongee/article/details/24271129" target="_blank" rel="noopener">http://blog.csdn.net/loongee/article/details/24271129</a></p><p><a href="http://blog.csdn.net/chexlong/article/details/6963541" target="_blank" rel="noopener">http://blog.csdn.net/chexlong/article/details/6963541</a></p><p><a href="http://www.cnblogs.com/TianFang/archive/2011/12/20/2294603.html" target="_blank" rel="noopener">http://www.cnblogs.com/TianFang/archive/2011/12/20/2294603.html</a></p><p>本文使用boost的Asio来跨平台实现NTP Client.</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ol><li>最新的boost库，本文使用的是1.56.0版本<br>要用到里面的ASIO网络库</li><li>IDE是Visual Studio 2013 with Update3<br>笔者是版本帝</li><li>WireShark也是最新的1.12.1版本<br>用来分析Windows自带的NTP Client</li></ol><h2 id="NTP-Packet分析"><a href="#NTP-Packet分析" class="headerlink" title="NTP Packet分析"></a>NTP Packet分析</h2><p>这里我们分析的正是上图那个程序，点击立即更新，会发送NTP的请求包，下面是Wireshark的抓包结果：</p><p><img src="105506_Pfy8_580940.png" alt=""></p><p>可以得到下面一些信息：</p><ol><li>NTP时间同步分两个过程，一个Request，一个Response</li><li>这里的NTP Server的IP地址是<strong>129.6.15.28</strong></li><li>程序没有进行DNS解析，可能是直接保存了IP地址</li><li>NTP服务的端口号是123，Client也使用了<strong>123端口</strong>，后来发现Client不是一定要使用123端口的</li><li>NTP协议是构建在<strong>UDP传输协议</strong>上的应用协议</li><li>这里使用V3版的NTP协议，目前还有v4</li></ol><p>好了，有了关于NTP协议的一些基本信息，我们再来看看应用层的详细信息：</p><p><strong>Response</strong>包：</p><p><img src="110611_s2ke_580940.png" alt=""></p><p>分了很多字段，关于每个字段的含义请参考上面给出的链接，本文主要讲实现。这里Reference Timestamp就是Request包发送的Timestamp，而Origin,Receive,Transmit都是从Server返回回来的时间，后三个时间都相差非常小，因此方便一点，我们取最后一个Transmit Timestamp作为结果。</p><h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>boost里面相关库的编译可以参考官方的文档，里面有非常简单的例子。</p><h5 id="1-需要的头文件和名字空间"><a href="#1-需要的头文件和名字空间" class="headerlink" title="1. 需要的头文件和名字空间"></a>1. 需要的头文件和名字空间</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"boost/asio.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"boost/date_time/posix_time/posix_time.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::posix_time;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::asio::ip;</span><br></pre></td></tr></table></figure>
<h5 id="2-NtpPacket的构造"><a href="#2-NtpPacket的构造" class="headerlink" title="2. NtpPacket的构造"></a>2. NtpPacket的构造</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NtpPacket</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    NtpPacket() &#123;</span><br><span class="line">        _rep._flags = <span class="number">0xdb</span>;</span><br><span class="line">        <span class="comment">//    11.. ....    Leap Indicator: unknown</span></span><br><span class="line">        <span class="comment">//    ..01 1...    NTP Version 3</span></span><br><span class="line">        <span class="comment">//    .... .011    Mode: client</span></span><br><span class="line">        _rep._pcs = <span class="number">0x00</span>;<span class="comment">//unspecified</span></span><br><span class="line">        _rep._ppt = <span class="number">0x01</span>;</span><br><span class="line">        _rep._pcp = <span class="number">0x01</span>;</span><br><span class="line">        _rep._rdy = <span class="number">0x01000000</span>;<span class="comment">//big-endian</span></span><br><span class="line">        _rep._rdn = <span class="number">0x01000000</span>;</span><br><span class="line">        _rep._rid = <span class="number">0x00000000</span>;</span><br><span class="line">        _rep._ret = <span class="number">0x0</span>;</span><br><span class="line">        _rep._ort = <span class="number">0x0</span>;</span><br><span class="line">        _rep._rct = <span class="number">0x0</span>;</span><br><span class="line">        _rep._trt = <span class="number">0x0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> <span class="built_in">std</span>::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream&amp; os, <span class="keyword">const</span> NtpPacket&amp; ntpacket) &#123;</span><br><span class="line">        <span class="keyword">return</span> os.write(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt;(&amp;ntpacket._rep), <span class="keyword">sizeof</span>(ntpacket._rep));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> <span class="built_in">std</span>::istream&amp; <span class="keyword">operator</span>&gt;&gt;(<span class="built_in">std</span>::istream&amp; is, NtpPacket&amp; ntpacket) &#123;</span><br><span class="line">        <span class="keyword">return</span> is.read(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(&amp;ntpacket._rep), <span class="keyword">sizeof</span>(ntpacket._rep));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(1)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NtpHeader</span> &#123;</span></span><br><span class="line">        <span class="keyword">uint8_t</span> _flags;<span class="comment">//Flags</span></span><br><span class="line">        <span class="keyword">uint8_t</span> _pcs;<span class="comment">//Peer Clock Stratum</span></span><br><span class="line">        <span class="keyword">uint8_t</span> _ppt;<span class="comment">//Peer Polling Interval</span></span><br><span class="line">        <span class="keyword">uint8_t</span> _pcp;<span class="comment">//Peer Clock Precision</span></span><br><span class="line">        <span class="keyword">uint32_t</span> _rdy;<span class="comment">//Root Delay</span></span><br><span class="line">        <span class="keyword">uint32_t</span> _rdn;<span class="comment">//Root Dispersion</span></span><br><span class="line">        <span class="keyword">uint32_t</span> _rid;<span class="comment">//Reference ID</span></span><br><span class="line">        <span class="keyword">uint64_t</span> _ret;<span class="comment">//Reference Timestamp</span></span><br><span class="line">        <span class="keyword">uint64_t</span> _ort;<span class="comment">//Origin Timestamp</span></span><br><span class="line">        <span class="keyword">uint64_t</span> _rct;<span class="comment">//Receive Timestamp</span></span><br><span class="line">        <span class="keyword">uint64_t</span> _trt;<span class="comment">//Transmit Timestamp</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack()</span></span><br><span class="line">    NtpHeader _rep;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里为了方便存取就没有把struct放到private中，需要注意的是结构体各个字段的顺序和需要进行内存1字节对齐，即使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(1)</span></span><br></pre></td></tr></table></figure>
<p>内存对齐在网络编程中十分重要，他会直接影响Packet的内容，关于内存对齐可以参考：</p>
<p><a href="http://www.cppblog.com/cc/archive/2006/08/01/10765.html" target="_blank" rel="noopener">http://www.cppblog.com/cc/archive/2006/08/01/10765.html</a></p>
<p>NTP请求包中最重要的是flags，里面存有版本信息等直接影响协议工作的内容，因此不能搞错了。</p>
<p>两个operator重载用来方便读写Packet数据。</p>
<p>再来看看Client类的实现，Client类的主要任务就是发送和接受NTP包，并返回最后那个64bit的Timestamp。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NtpClient</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    NtpClient(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; serverIp)</span><br><span class="line">        :_socket(io), _serverIp(serverIp) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">time_t</span> getTime() &#123;</span><br><span class="line">        <span class="keyword">if</span> (_socket.is_open()) &#123;</span><br><span class="line">            _socket.shutdown(udp::socket::shutdown_both, _ec);</span><br><span class="line">            <span class="keyword">if</span> (_ec) &#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; _ec.message() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                _socket.close();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _socket.close();</span><br><span class="line">        &#125;</span><br><span class="line">        udp::endpoint ep(boost::asio::ip::address_v4::from_string(_serverIp), NTP_PORT);</span><br><span class="line">        NtpPacket request;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">stringstream</span> ss;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> buf;</span><br><span class="line">        ss &lt;&lt; request;</span><br><span class="line">        ss &gt;&gt; buf;</span><br><span class="line">        _socket.open(udp::v4());</span><br><span class="line">        _socket.send_to(boost::asio::buffer(buf), ep);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">uint8_t</span>, 128&gt; recv;</span><br><span class="line">        <span class="keyword">size_t</span> len = _socket.receive_from(boost::asio::buffer(recv), ep);</span><br><span class="line">        <span class="keyword">uint8_t</span>* pBytes = recv.data();</span><br><span class="line">        <span class="comment">/****dump hex data</span></span><br><span class="line"><span class="comment">        for (size_t i = 0; i &lt; len; i++) &#123;</span></span><br><span class="line"><span class="comment">        if (i % 16 == 0) &#123;</span></span><br><span class="line"><span class="comment">        std::cout &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        else &#123;</span></span><br><span class="line"><span class="comment">        std::cout &lt;&lt; std::setw(2) &lt;&lt; std::setfill('0')</span></span><br><span class="line"><span class="comment">        &lt;&lt; std::hex &lt;&lt; (uint32_t) pBytes[i];</span></span><br><span class="line"><span class="comment">        std::cout &lt;&lt; ' ';</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        ****/</span></span><br><span class="line">        <span class="keyword">time_t</span> tt;</span><br><span class="line">        <span class="keyword">uint64_t</span> last;</span><br><span class="line">        <span class="keyword">uint32_t</span> seconds;</span><br><span class="line">        <span class="comment">/****get the last 8 bytes(Transmit Timestamp) from received packet.</span></span><br><span class="line"><span class="comment">        std::memcpy(&amp;last, pBytes + len - 8, sizeof(last));</span></span><br><span class="line"><span class="comment">        ****create a NtpPacket*/</span></span><br><span class="line">        NtpPacket resonpse;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">stringstream</span> rss;</span><br><span class="line">        rss.write(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(pBytes), len);</span><br><span class="line">        rss &gt;&gt; resonpse;</span><br><span class="line">        last = resonpse._rep._trt;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        reverseByteOrder(last);</span><br><span class="line">        seconds = (last &amp; <span class="number">0x7FFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        tt = seconds + <span class="number">8</span> * <span class="number">3600</span> * <span class="number">2</span> - <span class="number">61533950</span>;</span><br><span class="line">        <span class="keyword">return</span> tt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint16_t</span> NTP_PORT = <span class="number">123</span>;</span><br><span class="line">    udp::socket _socket;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> _serverIp;</span><br><span class="line">    boost::system::error_code _ec;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意几个地方：</p>
<h5 id="1-udp-socket是boost里面使用udp协议的套接字，他的构造需要一个io-service，io-service可以直接在全局区进行声明："><a href="#1-udp-socket是boost里面使用udp协议的套接字，他的构造需要一个io-service，io-service可以直接在全局区进行声明：" class="headerlink" title="1. udp::socket是boost里面使用udp协议的套接字，他的构造需要一个io_service，io_service可以直接在全局区进行声明："></a>1. udp::socket是boost里面使用udp协议的套接字，他的构造需要一个io_service，io_service可以直接在全局区进行声明：</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">boost::asio::io_service io;</span><br></pre></td></tr></table></figure>
<h5 id="2-创建一个endpoint用来表示NTP-Server的地址："><a href="#2-创建一个endpoint用来表示NTP-Server的地址：" class="headerlink" title="2. 创建一个endpoint用来表示NTP Server的地址："></a>2. 创建一个endpoint用来表示NTP Server的地址：</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">udp::endpoint ep(boost::asio::ip::address_v4::from_string(_serverIp), NTP_PORT);</span><br></pre></td></tr></table></figure>
<p>向这个ep send_to，并从这个ep receive_from数据包。</p>
<h5 id="3-time-t的定义如下："><a href="#3-time-t的定义如下：" class="headerlink" title="3. time_t的定义如下："></a>3. time_t的定义如下：</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">__time64_t</span> <span class="keyword">time_t</span>;      <span class="comment">/* time value */</span></span><br><span class="line"><span class="keyword">typedef</span> __int64 <span class="keyword">__time64_t</span>;     <span class="comment">/* 64-bit time value */</span></span><br></pre></td></tr></table></figure>
<p>也就是说这个time_t其实就是一个64bit的int，我们可以用uint64_t这个类型与之互换，他可以用来表示一个Timestamp。</p>
<ol start="4">
<li><p>获取最后8字节内容有两种方式，一种是直接复制pBytes的内存，一种是构造NtpPacket，然后取成员，这里选择后者易于理解。</p>
</li>
<li><p>字节序的问题</p>
</li>
</ol>
<p>网络字节序都是大端模式，需要进行转换，由于仅仅需要最后那个uint64_t所以我写了一个针对64bit的字节序转换函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reverseByteOrder</span><span class="params">(<span class="keyword">uint64_t</span> &amp;in)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> rs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">memset</span>(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(&amp;rs) + len - <span class="number">1</span> - i</span><br><span class="line">                    , <span class="keyword">static_cast</span>&lt;<span class="keyword">uint8_t</span>&gt; ((in &amp; <span class="number">0xFF</span>LL &lt;&lt; (i * <span class="number">8</span>)) &gt;&gt; i * <span class="number">8</span>)</span><br><span class="line">                    , <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    in = rs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后一个64bit内容的高32位存了UTC秒数，所以需要取出来，然后再转换为本地时区的秒数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seconds = (last &amp; <span class="number">0x7FFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span>;</span><br></pre></td></tr></table></figure>
<p>注意最高位是不能取的，尽管是unsigned，至于为什么要- 61533950这个是笔者在自己电脑上尝试出来的，找了很多资料不知是哪里的问题，还请各位知道的读者告诉我哈。</p>
<p>再来看看主函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* agrv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">NtpClient <span class="title">ntp</span><span class="params">(<span class="string">"129.6.15.28"</span>)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">        <span class="keyword">time_t</span> tt = ntp.getTime();</span><br><span class="line">        boost::posix_time::ptime utc = <span class="keyword">from_time_t</span>(tt);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Local Timestamp:"</span> &lt;&lt; time(<span class="number">0</span>) &lt;&lt; <span class="string">'\t'</span> &lt;&lt; <span class="string">"NTP Server:"</span> &lt;&lt; tt &lt;&lt; <span class="string">"("</span> &lt;&lt; to_simple_string(utc) &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        Sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里进行5次NTP请求，并使用boost的to_simple_string转换UTC时间打印结果。</p>
<p>大概是这种效果：</p>
<p><img src="115316_jWZi_580940.png" alt=""></p>
<h2 id="收尾"><a href="#收尾" class="headerlink" title="收尾"></a>收尾</h2><p>同步时间一般都会想到找一个http api接口，本文主要是用了NTP协议。为了跨平台，上面的代码尽可能避免使用平台相关的宏和函数，只要稍作修改就能在各种平台下执行，也得益于boost这个强悍的准标准库给开发者带来的便利。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/08/28/cpp-factory-design-pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/08/28/cpp-factory-design-pattern/" itemprop="url">
                  C++我也来写个工厂模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-08-28T00:00:00+08:00">2014-08-28</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/08/28/cpp-factory-design-pattern/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/08/28/cpp-factory-design-pattern/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote><p>工厂方法模式（Factory method pattern）是一种实现了“工厂”概念的面向对象设计模式。就像其他创建型模式一样，它也是处理在不指定对象具体类型的情况下创建对象的问题。工厂方法模式的实质是“定义一个创建对象的接口，但让实现这个接口的类来决定实例化哪个类。工厂方法让类的实例化推迟到子类中进行。</p></blockquote><p>以前是没有实现过工厂模式，这里我用到了template来创建类型不同的Products，内存管理这块没想到更好的办法来cleanup，打算是利用析构自动release，不过貌似到模版里就捉禁见肘了。。大家有什么高见？</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ProductA</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ProductA::name()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm Product A."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProductB</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ProductB::name()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm Product B."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Factory</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Factory</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">static</span> T* <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	Factory();</span><br><span class="line">	<span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T*&gt; objs_;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T*&gt; Factory&lt;T&gt;::objs_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">Factory&lt;T&gt;::Factory()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">void</span> Factory&lt;T&gt;::cleanup()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">for</span> <span class="title">each</span> <span class="params">(T* obj in objs_)</span></span></span><br><span class="line"><span class="function">		<span class="title">if</span> <span class="params">(obj)</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"release "</span> &lt;&lt; obj &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">delete</span> obj;</span><br><span class="line">		obj = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	objs_.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">T* Factory&lt;T&gt;::create()</span><br><span class="line">&#123;</span><br><span class="line">	T * obj = <span class="keyword">new</span> T;</span><br><span class="line">	objs_.push_back(obj);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//create 10 ProductAs</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">auto</span> pa = Factory&lt;ProductA&gt;::create();</span><br><span class="line">		pa-&gt;name();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//create 10 ProductBs</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">auto</span> pb = Factory&lt;ProductB&gt;::create();</span><br><span class="line">		pb-&gt;name();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//free memory</span></span><br><span class="line">	Factory&lt;ProductA&gt;::cleanup();</span><br><span class="line">	Factory&lt;ProductB&gt;::cleanup();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/08/11/golang-ping-implememt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/08/11/golang-ping-implememt/" itemprop="url">
                  使用Golang实现简单Ping过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-08-11T00:00:00+08:00">2014-08-11</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/08/11/golang-ping-implememt/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/08/11/golang-ping-implememt/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>关于各种语言实现Ping已经是大家喜闻乐见的事情了，网络上利用Golang实现Ping已经有比较详细的代码示例，但大多是仅仅是实现了Request过程，而对Response的回显内容并没有做接收。而Ping程序不仅仅是发送一个ICMP，更重要的是如何接收并进行统计。</p><p>下面是网络上几篇关于Ping的实现代码：</p><p><a href="https://github.com/paulstuart/ping/blob/master/ping.go" target="_blank" rel="noopener">https://github.com/paulstuart/ping/blob/master/ping.go</a></p><p><a href="http://blog.csdn.net/gophers/article/details/21481447" target="_blank" rel="noopener">http://blog.csdn.net/gophers/article/details/21481447</a></p><p><a href="http://blog.csdn.net/laputa73/article/details/17226337" target="_blank" rel="noopener">http://blog.csdn.net/laputa73/article/details/17226337</a></p><p>本文借鉴了第二个链接里面的部分代码。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ol><li>安装最新的Go<br>由于Google被墙的原因，如果没有VPN的话，就到这里下载：<br><a href="http://www.golangtc.com/download" target="_blank" rel="noopener">http://www.golangtc.com/download</a></li><li>使用任意文本编辑器，或者LiteIDE会比较方便编译和调试，下面是LiteIDE的下载地址<br><a href="https://github.com/visualfc/liteide" target="_blank" rel="noopener">https://github.com/visualfc/liteide</a></li></ol><h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>要用到的package：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"container/list"</span></span><br><span class="line">	<span class="string">"encoding/binary"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ol>
<li>使用Golang提供的net包中的相关函数可以快速构造一个IP包并自定义其中一些关键参数，而不需要再自己手动填充IP报文。</li>
<li>使用encoding/binary包可以轻松获取结构体struct的内存数据并且可以规定字节序（这里要用网络字节序BigEndian），而不需要自己去转换字节序。之前的一片文中使用boost，还要自己去实现转换过程，详见：关于蹭网检查的原理及实现</li>
<li>使用container/list包，方便进行结果统计</li>
<li>使用time包实现耗时和超时处理</li>
</ol>
<p>ICMP报文struct：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ICMP <span class="keyword">struct</span> &#123;</span><br><span class="line">	Type        <span class="keyword">uint8</span></span><br><span class="line">	Code        <span class="keyword">uint8</span></span><br><span class="line">	Checksum    <span class="keyword">uint16</span></span><br><span class="line">	Identifier  <span class="keyword">uint16</span></span><br><span class="line">	SequenceNum <span class="keyword">uint16</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Usage提示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">arg_num := <span class="built_in">len</span>(os.Args)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> arg_num &lt; <span class="number">2</span> &#123;</span><br><span class="line">		fmt.Print(</span><br><span class="line">			<span class="string">"Please runAs [super user] in [terminal].\n"</span>,</span><br><span class="line">			<span class="string">"Usage:\n"</span>,</span><br><span class="line">			<span class="string">"\tgoping url\n"</span>,</span><br><span class="line">			<span class="string">"\texample: goping www.baidu.com"</span>,</span><br><span class="line">		)</span><br><span class="line">		time.Sleep(<span class="number">5e9</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>注意这个ping程序，包括之前的ARP程序都必须使用系统最高权限执行，所以这里先给出提示，使用time.Sleep(5e9)，暂停5秒，是为了使双击执行者看到提示，避免控制台一闪而过。</p>
<p>关键net对象的创建和初始化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">		icmp     ICMP</span><br><span class="line">		laddr    = net.IPAddr&#123;IP: net.ParseIP(<span class="string">"0.0.0.0"</span>)&#125;</span><br><span class="line">		raddr, _ = net.ResolveIPAddr(<span class="string">"ip"</span>, os.Args[<span class="number">1</span>])</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	conn, err := net.DialIP(<span class="string">"ip4:icmp"</span>, &amp;laddr, raddr)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br></pre></td></tr></table></figure>
<p>net.DialIP表示生成一个IP报文，版本号是v4，协议是ICMP（这里字符串ip4:icmp会把IP报文的协议字段设为1表示ICMP协议），</p>
<p>源地址laddr可以是0.0.0.0也可以是自己的ip，这个并不影响ICMP的工作。</p>
<p>目的地址raddr是一个URL，这里使用Resolve进行DNS解析，注意返回值是一个指针，所以下面的DialIP方法中参数表示没有取地址符。</p>
<p>这样一个完整的IP报文就装配好了，我们并没有去操心IP中的其他一些字段，Go已经为我们处理好了。</p>
<p>通过返回的conn *net.IPConn对象可以进行后续操作。</p>
<p>defer conn.Close() 表示该函数将在Return时被执行，确保不会忘记关闭。</p>
<p>下面需要构造ICMP报文了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">icmp.Type = <span class="number">8</span></span><br><span class="line">	icmp.Code = <span class="number">0</span></span><br><span class="line">	icmp.Checksum = <span class="number">0</span></span><br><span class="line">	icmp.Identifier = <span class="number">0</span></span><br><span class="line">	icmp.SequenceNum = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">	binary.Write(&amp;buffer, binary.BigEndian, icmp)</span><br><span class="line">	icmp.Checksum = CheckSum(buffer.Bytes())</span><br><span class="line">	buffer.Reset()</span><br><span class="line">	binary.Write(&amp;buffer, binary.BigEndian, icmp)</span><br></pre></td></tr></table></figure>
<p>仍然非常简单，利用binary可以把一个结构体数据按照指定的字节序读到缓冲区里面，计算校验和后，再读进去。</p>
<p>检验和算法参考上面给出的URL中的实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CheckSum</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">uint16</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		sum    <span class="keyword">uint32</span></span><br><span class="line">		length <span class="keyword">int</span> = <span class="built_in">len</span>(data)</span><br><span class="line">		index  <span class="keyword">int</span></span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">for</span> length &gt; <span class="number">1</span> &#123;</span><br><span class="line">		sum += <span class="keyword">uint32</span>(data[index])&lt;&lt;<span class="number">8</span> + <span class="keyword">uint32</span>(data[index+<span class="number">1</span>])</span><br><span class="line">		index += <span class="number">2</span></span><br><span class="line">		length -= <span class="number">2</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> length &gt; <span class="number">0</span> &#123;</span><br><span class="line">		sum += <span class="keyword">uint32</span>(data[index])</span><br><span class="line">	&#125;</span><br><span class="line">	sum += (sum &gt;&gt; <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">uint16</span>(^sum)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是Ping的Request过程，这里仿照Windows的ping，默认只进行4次：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">"\n正在 Ping %s 具有 0 字节的数据:\n"</span>, raddr.String())</span><br><span class="line">	recv := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">	statistic := list.New()</span><br><span class="line">	sended_packets := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">4</span>; i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> _, err := conn.Write(buffer.Bytes()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		sended_packets++</span><br><span class="line">		t_start := time.Now()</span><br><span class="line"></span><br><span class="line">		conn.SetReadDeadline((time.Now().Add(time.Second * <span class="number">5</span>)))</span><br><span class="line">		_, err := conn.Read(recv)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"请求超时"</span>)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		t_end := time.Now()</span><br><span class="line"></span><br><span class="line">		dur := t_end.Sub(t_start).Nanoseconds() / <span class="number">1e6</span></span><br><span class="line"></span><br><span class="line">		fmt.Printf(<span class="string">"来自 %s 的回复: 时间 = %dms\n"</span>, raddr.String(), dur)</span><br><span class="line"></span><br><span class="line">		statistic.PushBack(dur)</span><br><span class="line"></span><br><span class="line">		<span class="comment">//for i := 0; i &lt; recvsize; i++ &#123;</span></span><br><span class="line">		<span class="comment">//	if i%16 == 0 &#123;</span></span><br><span class="line">		<span class="comment">//		fmt.Println("")</span></span><br><span class="line">		<span class="comment">//	&#125;</span></span><br><span class="line">		<span class="comment">//	fmt.Printf("%.2x ", recv[i])</span></span><br><span class="line">		<span class="comment">//&#125;</span></span><br><span class="line">		<span class="comment">//fmt.Println("")</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>“具有0字节的数据”表示ICMP报文中没有数据字段，这和Windows里面32字节的数据的略有不同。</p>
<p>conn.Write方法执行之后也就发送了一条ICMP请求，同时进行计时和计次。</p>
<p>conn.SetReadDeadline可以在未收到数据的指定时间内停止Read等待，并返回错误err，然后判定请求超时。否则，收到回应后，计算来回所用时间，并放入一个list方便后续统计。</p>
<p>注释部分内容是我在探索返回数据时的代码，读者可以试试看Read到的数据是哪个数据包的？</p>
<p>统计工作将在循环结束时进行，这里使用了defer其实是希望按了Ctrl+C之后能return执行，但是控制台确实不给力，直接给杀掉了。。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">""</span>)</span><br><span class="line">		<span class="comment">//信息统计</span></span><br><span class="line">		<span class="keyword">var</span> min, max, sum <span class="keyword">int64</span></span><br><span class="line">		<span class="keyword">if</span> statistic.Len() == <span class="number">0</span> &#123;</span><br><span class="line">			min, max, sum = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			min, max, sum = statistic.Front().Value.(<span class="keyword">int64</span>), statistic.Front().Value.(<span class="keyword">int64</span>), <span class="keyword">int64</span>(<span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> v := statistic.Front(); v != <span class="literal">nil</span>; v = v.Next() &#123;</span><br><span class="line"></span><br><span class="line">			val := v.Value.(<span class="keyword">int64</span>)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">switch</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> val &lt; min:</span><br><span class="line">				min = val</span><br><span class="line">			<span class="keyword">case</span> val &gt; max:</span><br><span class="line">				max = val</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			sum = sum + val</span><br><span class="line">		&#125;</span><br><span class="line">		recved, losted := statistic.Len(), sended_packets-statistic.Len()</span><br><span class="line">		fmt.Printf(<span class="string">"%s 的 Ping 统计信息：\n  数据包：已发送 = %d，已接收 = %d，丢失 = %d (%.1f%% 丢失)，\n往返行程的估计时间(以毫秒为单位)：\n  最短 = %dms，最长 = %dms，平均 = %.0fms\n"</span>,</span><br><span class="line">			raddr.String(),</span><br><span class="line">			sended_packets, recved, losted, <span class="keyword">float32</span>(losted)/<span class="keyword">float32</span>(sended_packets)*<span class="number">100</span>,</span><br><span class="line">			min, max, <span class="keyword">float32</span>(sum)/<span class="keyword">float32</span>(recved),</span><br><span class="line">		)</span><br><span class="line">	&#125;()</span><br></pre></td></tr></table></figure>
<p>统计过程注意类型的转换和格式化就行了。</p>
<p>全部代码就这些，执行结果大概是这个样子的：</p>
<p><img src="173508_b4Xw_580940.png" alt=""></p>
<p>注意每次Ping后都没有”休息”，不像Windows或者Linux的会停顿几秒再Ping下一轮。</p>
<h2 id="收尾"><a href="#收尾" class="headerlink" title="收尾"></a>收尾</h2><p>Golang实现整个Ping比我想象中的还要简单很多，静态编译速度是十分快速，相比C而言，你需要更多得了解底层，甚至要从链路层开始，你需要写更多更复杂的代码来完成相同的工作，但究其根本，C语言仍然是鼻祖，功不可没，很多原理和思想都要继承和发展，这一点Golang做的很好。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/08/02/network-rub-inspection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/08/02/network-rub-inspection/" itemprop="url">
                  关于蹭网检查的原理及实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-08-02T00:00:00+08:00">2014-08-02</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/08/02/network-rub-inspection/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/08/02/network-rub-inspection/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>网络十分普及的现在,几乎每家每户都用上了无线局域网, 但也时常因为路由器密码泄露或破解被别人蹭网,加之WiFi 万能钥匙等软件的流行, 越来越多人加入了蹭网大军, 也给不少小型局域网用户带来了烦恼. 目前许多安全软件厂商都在推出检查蹭网的小程序, 通过这样的程序可以十分便捷的看到哪些设备在使用局域网, 从而及时发现和采取应对措施, 为广大用户弥补了损失.</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>笔者手里正好有一款由nisoft发布的检查蹭网的小程序, 叫做Wireless Network Watcher, 软件免费试用, 文末将给出下载地址. 本文将针对该款软件做分析. 其次是WireShark协议分析工具, 这个软件很常见, 感兴趣的话可以百度下载.</p><p>笔者的系统仍然是Windows8.1 Pro.</p><p>操作步骤</p><p>1.打开Wireless Network Watcher, 在Advanced Options中设置合适的Network adapter(可能含有其他网络设备的网段), 笔者主机所在网段是192.168.199.*</p><p>2.打开WireShark,选择合适的网卡然后启动监控</p><p>3.启动Wireless Network Watcher的扫描</p><p>4.等待扫描结束,然后停止两个软件</p><p>5.在WireShark中进行分析</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从Wireless Network Watcher的扫描结果来看,除了Router之外还发现了3个设备,一个是我的主机(Your Computer),一个是我的安卓手机,还有一个是HyFi智能无线路由器.</p><p><img src="094819_bH4F_580940.png" alt=""></p><p>此外,包括MAC地址在内的IP地址, 设备名称Device Name等等都获取到了.</p><p>从Wireshark的抓包结果来看, 大多数是ARP协议, 在ARP应答报文中可以得到对应在线主机的MAC地址, 程序在收到应答后有一个DNS反向解析动作, 在DNS应答中又可以得到设备的Device Name,而这个Device Name应该是存在Router中的. 过滤其他干扰协议保留ARP和DNS. 可以十分明显的发现ARP请求报文的 Target IP address是从网段中0开始,一直到255, 也就是说软件扫描了整个网段, 发送了256个ARP广播用来查找在线的主机, 然后通过得到的IP地址向路由器发送DNS反向解析请求,用来获取设备的名称. 如图所示:</p><p><img src="095528_SLfJ_580940.png" alt=""></p><p>这里先借一段关于ARP协议的百科:</p><blockquote><p>地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址的一个TCP/IP协议。其功能是：主机将ARP请求广播到网络上的所有主机，并接收返回消息，确定目标IP地址的物理地址，同时将IP地址和硬件地址存入本机ARP缓存中，下次请求时直接查询ARP缓存。地址解析协议是建立在网络中各个主机互相信任的基础上的，网络上的主机可以自主发送ARP应答消息，其他主机收到应答报文时不会检测该报文的真实性就会将其记录在本地的ARP缓存中，这样攻击者就可以向目标主机发送伪ARP应答报文，使目标主机发送的信息无法到达相应的主机或到达错误的主机，构成一个ARP欺骗。ARP命令可用于查询本机ARP缓存中IP地址和MAC地址的对应关系、添加或删除静态对应关系等。</p><p>—- 百度百科</p></blockquote><p>通过这段引用可以了解到ARP协议的Request是一个广播,发送到网络上所有主机,然后接收应答.</p><p>关于DNS的工作原理可以参考我的另一篇文: 《利用WireShark进行DNS协议分析》</p><hr><p>现在让我们来分析一个ARP的请求和应答,以及一个DNS的请求和应答.</p><p>以第一个ARP为例:</p><p><img src="100636_zeua_580940.png" alt=""></p><p>第一个包是ARP请求,第二个是ARP应答,第三个是DNS请求,第四个是DNS应答,下面依次分析:</p><p><strong>1. ARP请求</strong></p><p><img src="101024_Bzhc_580940.png" alt=""></p><p>ARP请求的关键在于目标MAC尚未知道,因此全0,注意上层协议中的目标MAC是全f, 表示一个广播, 由于不同层的协议不同, 因此含义也不同. 请求解析的地址是192.168.199.1, opcode为 0x0001代表该ARP是一个Request.</p><p>ARP报文格式不在本文的讨论范围, 其本身也比较简单. 请读者自行百度.</p><p><strong>2. ARP应答</strong></p><p><img src="101615_4Mra_580940.png" alt=""></p><p>当ARP请求广播后, 收到请求的主机检查Target IP address是否和自己相同,相同就回应一个ARP, 注意此时不再是一个广播了,而是定向的回应发送者. Sender MAC address字段里放有我们希望得到的目标MAC地址.</p><p>主机得到来自192.168.199.1的应答后, 取出MAC并记下IP地址, 为后面的DNS反向解析做准备.</p><p>其实到此为止, 就探测到了一个在线的主机, 完成了关键的侦测任务, 下面的DNS是软件本身为了优化用户体验, 向路由器查询一下设备名称而已. 此外,如果广播出去的ARP一定时间内没有收到回应,说明所探测的主机不在线.</p><p><strong>3. DNS请求</strong></p><p><img src="102645_XXOZ_580940.png" alt=""></p><p>主机收到ARP回应后, 利用IP地址进行DNS反向解析, 注意查询IP字段在报文中是逆序存放的. 目的地是路由器.</p><p><strong>4. DNS应答</strong></p><p><img src="102907_mxkv_580940.png" alt=""></p><p>DNS应答报文中指出Domain Name是 Hiwifi.lan 这和软件上的Device Name一致.</p><hr><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>之前直接打算用boost的asio网络库来实现ARP的收发,搞了半天发现asio的rawsocket不能自定义实现这样的底层协议,网络上关于boost实现ARP的资料几乎没有,因此考虑了windows平台下的winpcap.</p><p>首先需要自己定义好arp以及ethernet报文(帧)的标准格式,为了简便起见,成员函数全部使用inline方式, 下面两个hpp分别定义了这两种格式:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ethernet_header.hpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ETHERNET_HEADER_HPP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETHERNET_HEADER_HPP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;istream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"mac_address.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ethernet header </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The wire format of an Ethernet header is:</span></span><br><span class="line"><span class="comment">// 0                 5                 11    13</span></span><br><span class="line"><span class="comment">// +-----------------+-----------------+-----+</span></span><br><span class="line"><span class="comment">// |destination mac  |source mac       |type |</span></span><br><span class="line"><span class="comment">// |XX:XX:XX:XX:XX:XX|YY:YY:YY:YY:YY:YY|ZZ:ZZ|</span></span><br><span class="line"><span class="comment">// +-----------------+-----------------+-----+</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ethernet_header</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	ethernet_header() &#123; <span class="built_in">std</span>::fill(rep_, rep_ + <span class="keyword">sizeof</span>(rep_), <span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">dst</span><span class="params">(<span class="keyword">const</span> MacAddr &amp;mac_address)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mac_address.size(); ++i) &#123;</span><br><span class="line">			rep_[<span class="number">0</span> + i] = mac_address[i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">src</span><span class="params">(<span class="keyword">const</span> MacAddr &amp;mac_address)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mac_address.size(); ++i) &#123;</span><br><span class="line">			rep_[<span class="number">6</span> + i] = mac_address[i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">type</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> n)</span> </span>&#123; encode(<span class="number">12</span>, <span class="number">13</span>, n); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">MacAddr <span class="title">dst</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">		MacAddr mac_address;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i) &#123;</span><br><span class="line">			mac_address.push_back(rep_[<span class="number">0</span> + i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> mac_address;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">MacAddr <span class="title">src</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">		MacAddr mac_address;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i) &#123;</span><br><span class="line">			mac_address.push_back(rep_[<span class="number">6</span> + i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> mac_address;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">type</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> decode(<span class="number">12</span>, <span class="number">13</span>); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">friend</span> <span class="built_in">std</span>::istream&amp; <span class="keyword">operator</span>&gt;&gt;(<span class="built_in">std</span>::istream&amp; is, ethernet_header&amp; header)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> is.read(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(header.rep_), <span class="number">14</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">friend</span> <span class="built_in">std</span>::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream&amp; os, <span class="keyword">const</span> ethernet_header&amp; header)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> os.write(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(header.rep_), <span class="number">14</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">decode</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (rep_[a] &lt;&lt; <span class="number">8</span>) + rep_[b];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">encode</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">unsigned</span> <span class="keyword">short</span> n)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		rep_[a] = <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;(n &gt;&gt; <span class="number">8</span>);</span><br><span class="line">		rep_[b] = <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;(n &amp; <span class="number">0xFF</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> rep_[<span class="number">14</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// ETHERNET_HEADER_HPP</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arp_header.hpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ARP_HEADER_HPP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ARP_HEADER_HPP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;istream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/asio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"mac_address.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ARP header</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The wire format of an ARP header is:</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// 0               8               16                             31</span></span><br><span class="line"><span class="comment">// +-------------------------------+------------------------------+      ---</span></span><br><span class="line"><span class="comment">// |                               |                              |       ^</span></span><br><span class="line"><span class="comment">// |     Hardware type (HTYPE)     |    Protocol type (PTYPE)     |       |</span></span><br><span class="line"><span class="comment">// |                               |                              |       |</span></span><br><span class="line"><span class="comment">// +---------------+---------------+------------------------------+    4 bytes</span></span><br><span class="line"><span class="comment">// |               |               |                              |       ^</span></span><br><span class="line"><span class="comment">// |   Hard. len.  |  Proto. len.  |       Operation (OPER)       |       |</span></span><br><span class="line"><span class="comment">// |    (HLEN)     |    (PLEN)     |                              |       |</span></span><br><span class="line"><span class="comment">// +-------------------------------+------------------------------+    8 bytes</span></span><br><span class="line"><span class="comment">// |                                                              |       ^</span></span><br><span class="line"><span class="comment">// |                  Sender hardware address (SHA)               |       |</span></span><br><span class="line"><span class="comment">// |                                                              |       |</span></span><br><span class="line"><span class="comment">// +--------------------------------------------------------------+    14 bytes</span></span><br><span class="line"><span class="comment">// |                                                              |       ^</span></span><br><span class="line"><span class="comment">// |                  Sender protocol address (SPA)               |       |</span></span><br><span class="line"><span class="comment">// |                                                              |       |</span></span><br><span class="line"><span class="comment">// +--------------------------------------------------------------+    18 bytes</span></span><br><span class="line"><span class="comment">// |                                                              |       ^</span></span><br><span class="line"><span class="comment">// |                  Target hardware address (THA)               |       |</span></span><br><span class="line"><span class="comment">// |                                                              |       |</span></span><br><span class="line"><span class="comment">// +--------------------------------------------------------------+    24 bytes</span></span><br><span class="line"><span class="comment">// |                                                              |       ^</span></span><br><span class="line"><span class="comment">// |                  Target protocol address (TPA)               |       |</span></span><br><span class="line"><span class="comment">// |                                                              |       |</span></span><br><span class="line"><span class="comment">// +--------------------------------------------------------------+    28 bytes</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">arp_header</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	arp_header()&#123; <span class="built_in">std</span>::fill(rep_, rep_ + <span class="keyword">sizeof</span>(rep_), <span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//setter</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">htype</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> n)</span></span>&#123; encode(<span class="number">0</span>, <span class="number">1</span>, n); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ptype</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> n)</span></span>&#123; encode(<span class="number">2</span>, <span class="number">3</span>, n); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">hsize</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> n)</span></span>&#123; rep_[<span class="number">4</span>] = n; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">psize</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> n)</span></span>&#123; rep_[<span class="number">5</span>] = n; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">opcode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> n)</span></span>&#123; encode(<span class="number">6</span>, <span class="number">7</span>, n); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">sha</span><span class="params">(<span class="keyword">const</span> MacAddr &amp; mac)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mac.size(); ++i)</span><br><span class="line">			rep_[<span class="number">8</span> + i] = mac[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">spa</span><span class="params">(<span class="keyword">const</span> boost::asio::ip::address_v4 &amp;address)</span></span>&#123;</span><br><span class="line">		<span class="keyword">auto</span> bytes = address.to_bytes();</span><br><span class="line">		rep_[<span class="number">14</span>] = bytes[<span class="number">0</span>];</span><br><span class="line">		rep_[<span class="number">15</span>] = bytes[<span class="number">1</span>];</span><br><span class="line">		rep_[<span class="number">16</span>] = bytes[<span class="number">2</span>];</span><br><span class="line">		rep_[<span class="number">17</span>] = bytes[<span class="number">3</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">tha</span><span class="params">(<span class="keyword">const</span> MacAddr&amp; mac)</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mac.size(); ++i)</span><br><span class="line">			rep_[<span class="number">18</span> + i] = mac[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">tpa</span><span class="params">(<span class="keyword">const</span> boost::asio::ip::address_v4 &amp;address)</span></span>&#123;</span><br><span class="line">		<span class="keyword">auto</span> bytes = address.to_bytes();</span><br><span class="line">		rep_[<span class="number">24</span>] = bytes[<span class="number">0</span>];</span><br><span class="line">		rep_[<span class="number">25</span>] = bytes[<span class="number">1</span>];</span><br><span class="line">		rep_[<span class="number">26</span>] = bytes[<span class="number">2</span>];</span><br><span class="line">		rep_[<span class="number">27</span>] = bytes[<span class="number">3</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//getter</span></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">htype</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> decode(<span class="number">0</span>, <span class="number">1</span>); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">ptype</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> decode(<span class="number">2</span>, <span class="number">3</span>); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">hsize</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> rep_[<span class="number">4</span>]; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">psize</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> rep_[<span class="number">5</span>]; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">opcode</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> decode(<span class="number">6</span>, <span class="number">7</span>); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">MacAddr <span class="title">sha</span><span class="params">()</span><span class="keyword">const</span> </span>&#123;</span><br><span class="line">		MacAddr mac;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">			mac.push_back(rep_[<span class="number">8</span> + i]);</span><br><span class="line">		<span class="keyword">return</span> mac;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	boost::asio::ip::<span class="function">address_v4 <span class="title">spa</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">		boost::asio::ip::address_v4::bytes_type bytes</span><br><span class="line">			= &#123;rep_[<span class="number">14</span>], rep_[<span class="number">15</span>], rep_[<span class="number">16</span>], rep_[<span class="number">17</span>]&#125;;</span><br><span class="line">		<span class="keyword">return</span> boost::asio::ip::address_v4(bytes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">MacAddr <span class="title">tha</span><span class="params">()</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">		MacAddr mac;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i)</span><br><span class="line">			mac.push_back(rep_[<span class="number">18</span> + i]);</span><br><span class="line">		<span class="keyword">return</span> mac;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	boost::asio::ip::<span class="function">address_v4 <span class="title">tpa</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">		boost::asio::ip::address_v4::bytes_type bytes</span><br><span class="line">			= &#123;rep_[<span class="number">24</span>], rep_[<span class="number">25</span>], rep_[<span class="number">26</span>], rep_[<span class="number">27</span>]&#125;;</span><br><span class="line">		<span class="keyword">return</span> boost::asio::ip::address_v4(bytes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//overloads</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">friend</span> <span class="built_in">std</span>::istream&amp; <span class="keyword">operator</span>&gt;&gt;(<span class="built_in">std</span>::istream&amp; is, arp_header&amp; header)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> is.read(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(header.rep_), <span class="number">28</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">friend</span> <span class="built_in">std</span>::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream&amp; os, <span class="keyword">const</span> arp_header&amp; header)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> os.write(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(header.rep_), <span class="number">28</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">encode</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">unsigned</span> <span class="keyword">short</span> n)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		rep_[a] = <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;(n &gt;&gt; <span class="number">8</span>);<span class="comment">//取出高8位</span></span><br><span class="line">		rep_[b] = <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;(n &amp; <span class="number">0xff</span>);<span class="comment">//取出低8位</span></span><br><span class="line">		<span class="comment">//相当于转换字节序,把小端格式转换为网络字节序</span></span><br><span class="line">		<span class="comment">//例如 数 0x1234 在小端模式(Little-endian)中表示为:</span></span><br><span class="line">		<span class="comment">//低地址----&gt;高地址</span></span><br><span class="line">		<span class="comment">//34         12</span></span><br><span class="line">		<span class="comment">//网络序,大端模式(Big-endian)应该是:</span></span><br><span class="line">		<span class="comment">//12         34</span></span><br><span class="line">		<span class="comment">//该函数实现这个功能</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">decode</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (rep_[a] &lt;&lt; <span class="number">8</span>) + rep_[b];</span><br><span class="line">		<span class="comment">//这个就是encode的反函数,把两个字节倒过来返回</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> rep_[<span class="number">28</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// ARP_HEADER_HPP</span></span></span><br></pre></td></tr></table></figure>
<p>关于主机字节序(本例为小端)和网络字节序(大端)的转换过程可以参考上面代码中的注释.</p>
<p>实在贴不下这么多代码了,主函数代码包括所有本文涉及的hpp源代码请见下面的代码分享链接.</p>
<p>由于时间仓促,代码仅供学习交流,有很多遗留的问题尚未解决,但并不影响大家对整个实现过程的理解</p>
<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><p><img src="175051_JQJJ_580940.png" alt=""></p>
<p>程序将扫描定义好的整个ip区段,发送ARP广播,然后接收响应,列出目标的MAC地址.具体实现请看下面的代码分享.</p>
<h2 id="代码分享"><a href="#代码分享" class="headerlink" title="代码分享"></a>代码分享</h2><p><a href="http://www.oschina.net/code/snippet_580940_37722" target="_blank" rel="noopener">http://www.oschina.net/code/snippet_580940_37722</a></p>
<h2 id="相关下载"><a href="#相关下载" class="headerlink" title="相关下载"></a>相关下载</h2><p><a href="http://www.nirsoft.net/utils/wireless_network_watcher.html" target="_blank" rel="noopener">Wireless Network Watcher</a></p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/07/15/wireshark-ping-icmp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/07/15/wireshark-ping-icmp/" itemprop="url">
                  利用WireShark分析由Ping产生的Internet 控制报文协议(ICMP)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-15T00:00:00+08:00">2014-07-15</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/07/15/wireshark-ping-icmp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/07/15/wireshark-ping-icmp/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote><p>ICMP是（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用</p></blockquote><p>CMP为TCP/IP协议簇中的成员,工作在网络层,作用是在主机和路由器之间传递控制信息.</p><p>上文中Ping命令完成DNS域名解析任务后,随即利用得到的第一条主机资源记录(A记录)中的IP地址发送ICMP请求报文:</p><p><img src="211623_9RVu_580940.png" alt=""></p><p>图中可以看到ICMP报文格式:</p><p><img src="212622_2e2c_580940.png" alt=""></p><p>Type(类型)以及Code(代码)合起来说明ICMP报文类型.</p><p>–这里ICMP的类型是:请求(0x8)表示ping请求; 响应(0x0)表示ping响应</p><p>Checksum(校验和)包含整个ICMP报文数据的校验.</p><p>ID(标识符)和Seq(序列号)由发送端任意设置,响应报文返回相同的值,用于配对请求和响应.</p><p>–比如,在这个例子中,ID字段和Seq有两种表示方式:大端和小端,在请求和响应报文中,ID值始终不变;但是每发送一次请求,Seq就被加一.</p><p>随后的Data数据段长度不固定,ping命令的发送的Echo请求数据是32bytes的a~i字符序列,且没有终止0,</p><p>刚好印证了为什么Ping时会显示: “Ping xxx 具有32字节的数据:” 这里32字节的数据就是a~i字符序列.</p><hr><p>ICMP响应报文中:</p><p><img src="214412_q1Oy_580940.png" alt=""></p><p>Type值是0x0,表示 ping reply,这一点显而易见的.</p><p>ID和Seq值和请求报文中的相同.</p><p>Data也是相同的.</p><p>在接收到响应之后同时计算出报文往返的时间,这里是Response time: 47.360ms</p><p>这样就完成了一次Ping</p><hr><p>之后的三个Ping其实是重复上述操作,只不过Seq序号字段要自增.</p><p>今天就到这里,欢迎大家学习交流,其实我更希望得到大家的意见,谢谢点赞~</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/07/15/wireshark-dns/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/07/15/wireshark-dns/" itemprop="url">
                  利用WireShark进行DNS协议分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-15T00:00:00+08:00">2014-07-15</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/07/15/wireshark-dns/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/07/15/wireshark-dns/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>系统是Windows 8.1Pro</p><p>分析工具是WireShark1.10.8 Stable Version</p><p>使用系统Ping命令发送ICMP报文.</p><h2 id="开始工作"><a href="#开始工作" class="headerlink" title="开始工作"></a>开始工作</h2><p>打开CMD.exe键入:</p><p>ping <a href="http://www.oschina.net" target="_blank" rel="noopener">www.oschina.net</a></p><p>将自动进行域名解析,默认发送4个ICMP报文.</p><p>启动Wireshark,选择一个有效网卡,启动抓包.</p><p>在控制台回车执行完毕后停止监控.</p><h2 id="分析阶段"><a href="#分析阶段" class="headerlink" title="分析阶段"></a>分析阶段</h2><p>截获的所有报文如下:</p><p><img src="105637_ELD7_580940.png" alt=""></p><p>总得来看有两个DNS包(一次域名解析),和8个ICMP包(四次ping)</p><p>下面开始分析DNS的工作过程:</p><p>打开第一个包:</p><p><img src="105955_GH0O_580940.png" alt=""></p><p>可以发现DNS为应用层协议,下层传输层采用UDP,再下层网络层是IP协议,然后是数据链路层的以太网帧.</p><p>需要关注的是应用层的实现也即DNS协议本身.</p><p>在此之前,可以从下层获得一些必要信息:</p><p>UDP(User Datagram Protocol)报文中: <strong>DNS的目的端口(Dst Port)是53</strong></p><p>IPv4(Internet Protocol Version 4)报文中目的IP是192.168.1.1(局域网路由器)</p><p>由于IP报文在网络层进行路由选择,他会依次送给路由器而不是直接送给DNS服务器,这一点也十分容易理解,</p><p>第一个包是请求包,不可能直接包含DNS服务器地址.</p><p>展开DNS数据:</p><p><img src="111309_VYYI_580940.png" alt=""></p><p>第一个是Transaction ID为标识字段,2字节,用于辨别DNS应答报文是哪个请求报文的响应.</p><p>第二个是Flags标志字段,2字节,每一位的含义不同,具体可以参考上面那个图,也可以看下面这个图:</p><p><img src="113034_JmcJ_580940.jpg" alt=""></p><p>QR: 查询/响应,1为响应,0为查询</p><p>Opcode: 查询或响应类型,这里0表示标准,1表示反向,2表示服务器状态请求</p><p>AA: 授权回答,在响应报文中有效,待会儿再看</p><p>TC: 截断,1表示超过512字节并已被截断,0表示没有发生截断</p><p>RD: 是否希望得到递归回答</p><p>RA: 响应报文中为1表示得到递归响应</p><p>zero: 全0保留字段</p><p>rcode: 返回码,在响应报文中,各取值的含义:</p><pre><code>0 - 无差错

1 - 格式错误

2 - 域名服务器出现错误

3 - 域参照问题

4 - 查询类型不支持

5 - 被禁止

6 ~ 15 保留
</code></pre><p>紧接着标志位的是</p><p>Quetions(问题数),2字节,通常为1</p><p>Answer RRs(资源记录数),Authority RRs(授权资源记录数),Additional RRs(额外资源记录数)通常为0</p><p>字段Queries为查询或者响应的正文部分,分为Name Type Class</p><p>Name(查询名称):这里是ping后的参数,不定长度以0结束</p><p>Type(查询类型):2字节,这里是主机A记录.其各个取值的含义如下:</p><pre><code>值        助记符         说明

 1         A                 IPv4地址。

 2         NS               名字服务器。

 5         CNAME        规范名称。定义主机的正式名字的别名。

 6         SOA             开始授权。标记一个区的开始。

 11       WKS             熟知服务。定义主机提供的网络服务。

 12       PTR               指针。把IP地址转化为域名。

 13       HINFO          主机信息。给出主机使用的硬件和操作系统的表述。

 15       MX               邮件交换。把邮件改变路由送到邮件服务器。

 28       AAAA           IPv6地址。

 252     AXFR            传送整个区的请求。

 255     ANY             对所有记录的请求。
</code></pre><p>Class(类):2字节,IN表示Internet数据,通常为1</p><hr><p>下面是截获的第二个DNS包:</p><p><img src="123716_Dner_580940.png" alt=""></p><p>可以看到和第一个请求包相比,响应包多出了一个Answers字段,同时Flags字段每一位都有定义.</p><p>关注一下Flags中Answer RRs 为4 说明对应的Answers字段中将会出现4项解析结果.</p><p>Answers字段可以看成一个List,集合中每项为一个资源记录,除了上面提到过的Name,Type,Class之外,还有Time to</p><p>Live,Data length,Addr.</p><p>Time to Live(生存时间TTL):表示该资源记录的生命周期,从取出记录到抹掉记录缓存的时间,以秒为单位.这里是0x00 00 00 fd 合计253s.</p><p>Data length(资源数据长度):以字节为单位,这里的4表示IP地址的长度为4字节.也就是下面Addr字段的长度.</p><p>Addr(资源数据): 返回的IP地址,就是我们想要的结果.</p><hr><p>可以发现有4条资源记录,4个不同的IP地址,说明域名 <a href="http://www.oschina.net" target="_blank" rel="noopener">www.oschina.net</a> 对应有4个IP地址,分别是:</p><p>112.124.5.74</p><p>219.136.249.194</p><p>61.145.122.155</p><p>121.9.213.124</p><p>CMD中显示的是第一条IP地址.我试了下直接访问上面各个地址的80端口(http),</p><p>第一个和第二个显示403 Forbidden</p><p>第三个和第四个显示404 Not Found</p><p>还有每个地址哦Server都不一样oscali,oscdb,liubc,ep2,第一个像阿里云服务器,第二个看起来像数据库的服务器,其他就不知道了…</p><p>Web服务器貌似是Tengine,</p><p>不知道为什么通过IP地址无法直接访问web站点,以后感兴趣再研究下哈哈</p><hr><p>关于ICMP协议的报文分析将在之后的文章中给出.今天先到这吧.</p><p>最后,欢迎大家评论交流~特别是OSC在搞什么鬼.</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/07/14/wireshark-telnet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/07/14/wireshark-telnet/" itemprop="url">
                  实战利用WireShark对Telnet协议进行抓包分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-14T00:00:00+08:00">2014-07-14</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/07/14/wireshark-telnet/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/07/14/wireshark-telnet/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote><p>Telnet协议是TCP/IP协议族中的一员，是Internet远程登陆服务的标准协议和主要方式。它为用户提供了在本地计算机上完成远程主机工作的能力。在终端使用者的电脑上使用telnet程序，用它连接到服务器。终端使用者可以在telnet程序中输入命令，这些命令会在服务器上运行，就像直接在服务器的控制台上输入一样。可以在本地就能控制服务器。要开始一个telnet会话，必须输入用户名和密码来登录服务器。Telnet是常用的远程控制Web服务器的方法。</p></blockquote><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul><li>虚拟机Virtual Box(Telnet服务端)<br>安装Windows XP SP3操作系统<br>开启了Telnet服务<br>添加了一个账户用于远程登录,用户名和密码都是micooz</li><li>宿主机Windows 8.1 Pro(Telnet客户端)<br>安装了分析工具Wireshark1.11.2<br>安装了Telnet客户端程序</li></ul><p>PS:虚拟机网卡选用桥接模式</p><h2 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h2><ol><li>开启虚拟机和Wireshark</li><li>查看XP获得的ip地址,这里是<strong>192.168.199.134</strong>;网卡MAC地址:08:00:27:a0:9f:f8<br>宿主机IP地址是<strong>192.168.199.154</strong>;网卡MAC地址:00:26:4d:a1:59:de</li><li>客户端主机启动cmd键入命令<br>telnet 192.168.199.134 回车</li><li>显示是否发送密码<br>回车</li><li>显示login:<br>键入micooz回车</li><li>显示password:<br>键入micooz回车</li><li>进入telnet客户端主界面命令行</li><li>键入net user回车</li><li>显示结果</li><li>关闭cmd</li><li>结束</li></ol><h2 id="开始分析"><a href="#开始分析" class="headerlink" title="开始分析"></a>开始分析</h2><p><strong>①建立连接(TCP三次握手)</strong></p><p>步骤3执行后,telnet客户端开始工作,首先是与虚拟机中的服务端程序建立TCP连接,从抓取的数据包来看,首先关于本次分析的数据包是典型的TCP三次握手,如图所示:</p><p><img src="111722_Jjvg_580940.png" alt=""></p><p>由于是我第一次搞网络协议分析,就TCP的三次握手过程也做一个分析吧.</p><p>主机(192.168.199.154)发送一个连接请求到虚拟机(192.168.199.134),第一个TCP包的格式如图所示:</p><p><img src="112904_6w07_580940.png" alt=""></p><p>|以太网v2头|ipv4报文|TCP报文|</p><p>其中以太网v2头是由数据链路层加上去的:</p><p>1-6bytes是目的地址,也即虚拟机的网卡MAC,</p><p>7-12bytes是源地址,也即宿主机MAC.</p><p>13-14(0x0800)是上层协议,这里是IP</p><p>第二段是ipv4的报文,网际协议IP是工作在网络层,也就是数据链路层的上层,上图数据区选中部分就是ipv4数据,其格式为:</p><p><img src="114355_Z2B3_580940.png" alt=""></p><p>可以非常清楚的看到那些教科书上讲到的IPv4报文格式在实际中式如何表现出来的.</p><p>值得注意的是,IPv4报文中的源地址和目的地址是ip地址,版本号TCP是6,标志字段是010就是禁止下层分段,且是完整的报文</p><p>第三段是TCP报文,从上面两个可以知道,这个TCP包被层层包装,经过下面一层就相应的包装一层,第三段是经过传输层的数</p><p>据,TCP报文的格式为:</p><p><img src="115604_mvis_580940.png" alt=""></p><p>和书本上讲的格式基本一致,这里说明了TCP的源端口52456也就是宿主机建立连接开出来的端口,目的端口23显然是</p><p>telnet服务默认端口.</p><p>Sequence number同步序号4bytes,这里是0xa1 21 e2 42,但这里显示的是相对值0.</p><p>Acknowledgment number确认序号4bytes,为0,因为还是第一个握手包.</p><p>Header Length头长度32字节,滑动窗口大小8192字节(8MB),校验和,紧急指针为0.</p><p>Options选项12字节,其中包含最大传输单元MTU默认是1460bytes.</p><p>再来看看第二个TCP数据包,它是一个来自虚拟机的应答,按照三次握手的原则,这个数据包中TCP报文确认序号应该等于上</p><p>一个请求包中的同步序号+1,我们来看一下是不是:</p><p>Pack1. Seq = 0xa1 21 e2 42 Ack = 0x00 00 00 00</p><p>Pack2. Seq = 0x97 0f 37 11 Ack = 0xa1 21 e2 43</p><p>看下图更清楚:</p><p><img src="125137_7Ecn_580940.png" alt=""></p><p>显然如TCP规定的那样工作. Flags字段中也显示出两个包的标志位.第一个是SYN,第二个是SYN,ACK.</p><p>那么显然第三个包应该这样工作:</p><p>Pack1. Seq = 0xa1 21 e2 42 [Ack = 0x00 00 00 00]</p><p>Pack2. Seq = 0x97 0f 37 11 Ack = 0xa1 21 e2 43</p><p>Pack3. [Seq = 0xa1 21 e2 43] Ack = 0x97 0f 37 12</p><p>主机收到Pack2,取出其中Seq+1赋给Ack,然后给虚拟机做出应答. Pack1中的Ack和Pack3中的Seq在一次完整的三次</p><p>握手中似乎没起到什么作用,如果发生丢失可能会起作用吧,这里没条件去测试.</p><p>那么,虽然还没正式进入Telnet的核心,但是TCP三次握手的流程基本清晰了.下面小结一下:</p><hr><p>1.TCP连接的建立通过三次握手完成.<br>2.TCP连接建立从传输层出发,TCP报文包装一个IP报头后形成一个IPv4报文经过网络层,然后再包装一个以太网帧头形成一个Ethernet帧通过数据链路层.<br>3.传输层的TCP报文含有Port端口地址; 网络层的IP报文中含有IP地址; 数据链路层中Ethernet帧含有MAC地址.可见层层<br>地址的不同之处,以及服务对象的不同之处.<br>4.三次握手规则就不再阐述了.</p><p><strong>②身份确认</strong></p><p>TCP连接建立后,主机和虚拟机相互交换一些信息,包括服务端的配置信息,主机的应答,是否需要登录等等,并且间断使用TCP</p><p>包保持连接.</p><p>当双方信息得到确认后,虚拟机发送欢迎信息(Welcome to Microsoft Telnet Service \r\n),主机做出应答</p><p>,随后又发送(\n\rlogin:),主机做出应答,然后同步一次,主机在CMD发生中断,接收用户输入,虚拟机等待用户输入.</p><p><img src="135919_c2Ku_580940.png" alt=""></p><p>主机输入一个字符就发送一个Telnet报文,然后远程返回一个应答,之后主机发送一个TCP报文.</p><p>三个一组:Telnet Telnet TCP</p><p><img src="140356_V3dZ_580940.png" alt=""></p><p>当然最后还有一个回车符\r\n也要产生三个数据包.</p><p>回车符发送之后,远端立即回送一个\n\rpassword:要求输入密码.</p><p><img src="140743_Jz4V_580940.png" alt=""></p><p>密码输入过程略有不同,一个字符产生两个包,一个是Telnet,一个是TCP.密码明文传输.</p><p><img src="141316_ja5G_580940.png" alt=""></p><p><strong>③命令执行和响应</strong></p><p>完成密码输入后,服务端验证成功后发送一个Telnet报文询问是否Do Terminal Type开始执行命令行,主机客户端回应Will Terminal Type,将要执行,然后双方发送Suboption End消息,之后服务端放送欢迎消息,如图:</p><p><img src="142132_cKft_580940.png" alt=""></p><p>那么之后就可以开始输入命令了,我输入的是net user\r\n</p><p><img src="142511_K1EA_580940.png" alt=""></p><p>和之前输入用户名的传输方法基本一样.两个Telnet一个TCP同步.</p><p>完成输入后回车,服务端执行命令并作出回应:</p><p><img src="142751_HseS_580940.png" alt=""></p><p>可以看到Administrator Guest HelpAssistant等字样,说明正确返回了执行结果.</p><hr><p>关闭CMD窗口时,产生了4个TCP包,第一个TCP包设置标志位FIN告知本次通信结束,服务端回应一个TCP,</p><p>表示做好准备关闭连接,随后又发送一个TCP包设置FIN告知客户端要准备断开连接并断开,客户端应答一个表示已断开.通信结束.</p><p><img src="143915_Opd3_580940.png" alt=""></p><p>这是典型的关闭TCP连接的过程.</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Telnet服务是建立在TCP基础之上的,保证数据的准确性.</p><p>建立连接后,每键入一个字符就要发送和应答,产生至少2个数据包,开销很大.</p><p>传统的Telnet由于密码明文传输的问题,帐号和密码等敏感资料容易会被窃听,因此很多服务器都会封锁Telnet服务,改</p><p>用更安全的SSH.</p><p>PS:本文是博主第一次尝试使用Wireshark进行网络协议分析,今后可能还会分析互联网其它一些协议,计算机网络</p><p>也是闲来无事自学的,本身非计算机专业,所以文中难免有专业术语或者概念性错误,还请批评指正!谢谢.</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2014/06/10/cpp-lambda-expression-asm-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/06/10/cpp-lambda-expression-asm-2/" itemprop="url">
                  C++11新特性中的匿名函数Lambda表达式的汇编实现分析（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-06-10T00:00:00+08:00">2014-06-10</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/06/10/cpp-lambda-expression-asm-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/06/10/cpp-lambda-expression-asm-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a href="/2014/06/09/cpp-lambda-expression-asm-1/" title="C++11新特性中的匿名函数Lambda表达式的汇编实现分析（一）">C++11新特性中的匿名函数Lambda表达式的汇编实现分析（一）</a><p>首先，让我们来看看以&amp;方式进行变量捕获，同样没有参数和返回。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="number">0xB</span>;</span><br><span class="line">	<span class="keyword">auto</span> lambda = [&amp;]&#123;</span><br><span class="line">		a = <span class="number">0xA</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">	lambda();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>闭包中将main中a变量改写为0xA。</p>
<p>main中的关键汇编代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">0xB</span>;</span><br><span class="line"> mov         dword ptr [ebp<span class="number">-8</span>],<span class="number">0B</span>h  </span><br><span class="line">	<span class="keyword">auto</span> lambda = [&amp;]&#123;</span><br><span class="line">		a = <span class="number">0xA</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"> lea         eax,[ebp<span class="number">-8</span>]  </span><br><span class="line"> push        eax  </span><br><span class="line"> lea         ecx,[ebp<span class="number">-14</span>h]  </span><br><span class="line"> call        <span class="number">002</span>D1BE0  </span><br><span class="line">	lambda();</span><br><span class="line"> lea         ecx,[ebp<span class="number">-14</span>h]  </span><br><span class="line"> call        <span class="number">002</span>D1C20  </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>同样的，进入闭包前要调用一个拷贝函数。</p>
<p>002D1BE0 内：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pop         ecx  </span><br><span class="line">mov         dword ptr [ebp<span class="number">-8</span>],ecx  </span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">mov         ecx,dword ptr [ebp+<span class="number">8</span>]  </span><br><span class="line">mov         dword ptr [eax],ecx  </span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">pop         edi  </span><br><span class="line">pop         esi  </span><br><span class="line">pop         ebx  </span><br><span class="line">mov         esp,ebp  </span><br><span class="line">pop         ebp  </span><br><span class="line">ret         <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>和前面一篇文章中的代码基本一致，但是有两个地方不同，</p>
<p>上文写到：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pop         ecx  </span><br><span class="line">mov         dword ptr [ebp<span class="number">-8</span>],ecx  </span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">mov         ecx,dword ptr [ebp+<span class="number">8</span>]  </span><br><span class="line">mov         edx,dword ptr [ecx]  </span><br><span class="line">mov         dword ptr [eax],edx  </span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]</span><br></pre></td></tr></table></figure>
<p>注意黑体部分，若采用<strong>[=]</strong>的捕获方式，那么将通过寄存器edx拷贝原变量的值；</p>
<p>若采用<strong>[&amp;]</strong>方式，则直接通过ecx拷贝原变量的<strong>地址</strong>，而不取出值。</p>
<p>闭包内：<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pop         ecx  </span><br><span class="line">mov         dword ptr [ebp<span class="number">-8</span>],ecx  </span><br><span class="line">	a = <span class="number">0xA</span>;</span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">mov         ecx,dword ptr [eax]  </span><br><span class="line">mov         dword ptr [ecx],<span class="number">0</span>Ah  </span><br><span class="line">&#125;;</span><br><span class="line">pop         edi  </span><br><span class="line">pop         esi  </span><br><span class="line">pop         ebx  </span><br><span class="line">mov         esp,ebp  </span><br><span class="line">pop         ebp  </span><br><span class="line">ret</span><br></pre></td></tr></table></figure><p></p>
<p>对a进行赋值，直接是：</p>
<p>*this = 0xA;</p>
<p>因为事先this就取到了a的地址。</p>
<p>可以发现，按引用捕获实际上就如同函数参数传递引用，传递的是一个地址值，而不创建对象副本（可以和上一篇文中的内容比较）。</p>
<p>C++11标准中对Lambda表达式的捕获内容还有一些特定支持，比如可以以指定的方式捕获指定的变量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="number">0xB</span>;</span><br><span class="line">	<span class="keyword">bool</span> b = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">auto</span> lambda = [&amp;a,b]&#123;</span><br><span class="line">		a = b;</span><br><span class="line">	&#125;;</span><br><span class="line">	lambda();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码对a进行引用捕获，对b按值捕获。根据前面分析的结果，可以预见，a的地址和b的值将被拷贝以供闭包函数使用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">0xB</span>;</span><br><span class="line"> mov         dword ptr [ebp<span class="number">-8</span>],<span class="number">0B</span>h  </span><br><span class="line">	<span class="keyword">bool</span> b = <span class="literal">true</span>;</span><br><span class="line"> mov         byte ptr [ebp<span class="number">-11</span>h],<span class="number">1</span>  </span><br><span class="line">	<span class="keyword">auto</span> lambda = [&amp;a,b]&#123;</span><br><span class="line">		a = b;</span><br><span class="line">	&#125;;</span><br><span class="line"> lea         eax,[ebp<span class="number">-11</span>h]  </span><br><span class="line"> push        eax  </span><br><span class="line"> lea         ecx,[ebp<span class="number">-8</span>]  </span><br><span class="line"> push        ecx  </span><br><span class="line"> lea         ecx,[ebp<span class="number">-24</span>h]  </span><br><span class="line"> call        <span class="number">00222060</span>  </span><br><span class="line">	lambda();</span><br><span class="line"> lea         ecx,[ebp<span class="number">-24</span>h]  </span><br><span class="line">	lambda();</span><br><span class="line"> call        <span class="number">00221</span>C20  </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>调用Lambda之前，先调用复制函数，传入两个参数，&amp;a和&amp;b，而this被放在main的[ebp-24h]中。</p>
<p>复制函数或者叫准备函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pop         ecx  </span><br><span class="line">mov         dword ptr [ebp<span class="number">-8</span>],ecx  </span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">mov         ecx,dword ptr [ebp+<span class="number">8</span>]  </span><br><span class="line">mov         dword ptr [eax],ecx  </span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">mov         ecx,dword ptr [ebp+<span class="number">0</span>Ch]  </span><br><span class="line">mov         dl,byte ptr [ecx]  </span><br><span class="line">mov         byte ptr [eax+<span class="number">4</span>],dl  </span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">pop         edi  </span><br><span class="line">pop         esi  </span><br><span class="line">pop         ebx  </span><br><span class="line">mov         esp,ebp  </span><br><span class="line">pop         ebp  </span><br><span class="line">ret         <span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>[eax] 就是 *this，也即a</p>
<p>[eax+4] 就是 *(this+4)，也即b</p>
<p>从内存图可以清楚的看到，a的地址被记录，b的值被复制</p>
<p><img src="125531_7Agm_580940.png" alt=""></p>
<p>闭包函数内：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pop         ecx  </span><br><span class="line">mov         dword ptr [ebp<span class="number">-8</span>],ecx  </span><br><span class="line">	a = b;</span><br><span class="line">mov         eax,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">movzx       ecx,byte ptr [eax+<span class="number">4</span>]  </span><br><span class="line"></span><br><span class="line">mov         edx,dword ptr [ebp<span class="number">-8</span>]  </span><br><span class="line">mov         eax,dword ptr [edx]  </span><br><span class="line">mov         dword ptr [eax],ecx</span><br></pre></td></tr></table></figure>
<p>b的值是从[eax+4]也即this+4中取出，而a在this中，其实就是：</p>
<p><em>(this) = </em>(this+4);</p>
<p>可以看到闭包内通过this作为基址，对闭包外的变量进行偏移访问。</p>
<p>下一篇中，我将对具有参数和返回值的Lambda表达式进行分析。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/master.portrait.png" alt="Micooz Lee">
            
              <p class="site-author-name" itemprop="name">Micooz Lee</p>
              <p class="site-description motion-element" itemprop="description">FullStack JavaScript Engineer</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">50</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/micooz" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:micooz@hotmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/MicoozLee" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://instagram.com/micoozlee" target="_blank" title="Instagram"><i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://flag.moe" title="哞菇菌" target="_blank">哞菇菌</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://haipz.com" title="海胖博客" target="_blank">海胖博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.otokaze.cn" title="音風の部屋" target="_blank">音風の部屋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.anotherhome.net" title="DIYgod" target="_blank">DIYgod</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.0xbbc.com" title="BlueCocoa" target="_blank">BlueCocoa</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://windisco.com" title="ShinCurry" target="_blank">ShinCurry</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://codelover.link" title="codelover" target="_blank">codelover</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.chionlab.moe" title="ChionTang" target="_blank">ChionTang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://rakume.com/#!/home" title="Rakume Hayashi" target="_blank">Rakume Hayashi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://src.moe" title="POJO" target="_blank">POJO</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Micooz Lee</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.1.0</div>
        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  

  
    <script id="dsq-count-scr" src="https://micooz.disqus.com/count.js" async></script>
  

  





	





  












  

  <script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){var r=!1,s=0,a=0,i=n.title.trim(),c=i.toLowerCase(),l=n.content.trim().replace(/<[^>]+>/g,""),h=l.toLowerCase(),p=decodeURIComponent(n.url),u=[],f=[];if(""!=i&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}u=u.concat(e(t,c,!1)),f=f.concat(e(t,h,!1))}),(u.length>0||f.length>0)&&(r=!0,s=u.length+f.length)),r){[u,f].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});function d(e,o,n,r){for(var s=r[r.length-1],i=s.position,c=s.word,l=[],h=0;i+c.length<=n&&0!=r.length;){c===t&&h++,l.push({position:i,length:c.length});var p=i+c.length;for(r.pop();0!=r.length&&(s=r[r.length-1],i=s.position,c=s.word,p>i);)r.pop()}return a+=h,{hits:l,start:o,end:n,searchTextCount:h}}var g=[];0!=u.length&&g.push(d(0,0,i.length,u));for(var v=[];0!=f.length;){var $=f[f.length-1],C=$.position,m=$.word,x=C-20,w=C+80;x<0&&(x=0),w<C+m.length&&(w=C+m.length),w>l.length&&(w=l.length),v.push(d(0,x,w,f))}v.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var y=parseInt("1");y>=0&&(v=v.slice(0,y));function T(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var b="";0!=g.length?b+="<li><a href='"+p+"' class='search-result-title'>"+T(i,g[0])+"</a>":b+="<li><a href='"+p+"' class='search-result-title'>"+i+"</a>",v.forEach(function(t){b+="<a href='"+p+'\'><p class="search-result">'+T(l,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:a,hitCount:s,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script>





  

  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.1.0"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.1.0"></script></body></html>