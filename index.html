<!DOCTYPE html><html class="theme-next pisces" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/uploads/apple-touch-icon.png?v=6.1.0"><link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32.png?v=6.1.0"><link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16.png?v=6.1.0"><link rel="mask-icon" href="/uploads/logo.svg?v=6.1.0" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"6.1.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="FullStack JavaScript Engineer"><meta property="og:type" content="website"><meta property="og:title" content="Micooz"><meta property="og:url" content="https://apporz.com/index.html"><meta property="og:site_name" content="Micooz"><meta property="og:description" content="FullStack JavaScript Engineer"><meta property="og:locale" content="en"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Micooz"><meta name="twitter:description" content="FullStack JavaScript Engineer"><link rel="alternate" href="/atom.xml" title="Micooz" type="application/atom+xml"><link rel="canonical" href="https://apporz.com/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>Micooz</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-72182315-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-72182315-1")</script><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Micooz</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Make something different!</p></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home menu-item-active"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://apporz.com/2018/04/14/implement-eventemitter-pipline/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Micooz Lee"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/master.portrait.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Micooz"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/04/14/implement-eventemitter-pipline/" itemprop="url">基于 EventEmitter 的双向数据 pipeline 实现</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-14T16:30:00+08:00">2018-04-14</time> </span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2018/04/14/implement-eventemitter-pipline/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/14/implement-eventemitter-pipline/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="基于-EventEmitter-的双向数据-pipeline-实现"><a href="#基于-EventEmitter-的双向数据-pipeline-实现" class="headerlink" title="基于 EventEmitter 的双向数据 pipeline 实现"></a>基于 EventEmitter 的双向数据 pipeline 实现</h1><h2 id="想法来源"><a href="#想法来源" class="headerlink" title="想法来源"></a>想法来源</h2><h2 id="Gulp"><a href="#Gulp" class="headerlink" title="Gulp"></a>Gulp</h2><p>Gulp 是前端工具链中常用的流式任务执行器，适用于许多小型库的编译打包任务。它的设计思想其实很像 Linux 命令行里面的 Pipe（管道）：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gulp.src(paths.scripts.src, &#123; <span class="attr">sourcemaps</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    .pipe(babel())</span><br><span class="line">    .pipe(uglify())</span><br><span class="line">    .pipe(concat(<span class="string">'main.min.js'</span>))</span><br><span class="line">    .pipe(gulp.dest(paths.scripts.dest));</span><br></pre></td></tr></table></figure>
<p>gulp 是单向的，即对于同一个 pipeline，数据一般不能被逆向还原。</p>
<h2 id="TCP-IP-stack"><a href="#TCP-IP-stack" class="headerlink" title="TCP/IP stack"></a>TCP/IP stack</h2><p>我们知道，计算机网络协议是<strong>分层设计</strong>的，每层分别为数据赋予不同的含义、完成不同的使命。源主机采用网络协议栈将原始二进制流 <strong>层层编码（encode）</strong> 后送往目的主机，目的主机采用同样的协议栈将数据 <strong>层层解码（decode）</strong> 后得到原始数据。典型的 HTTP 协议将请求数据通过 TCP/IP 协议栈自上而下编码后送出，之后自下而上解码后得到响应数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                                                      +---------+</span><br><span class="line">                                                      | &quot;Hello&quot; |</span><br><span class="line">                                                      +---------+</span><br><span class="line">                                        +-------------+---------+</span><br><span class="line">                                        | HTTP header | PAYLOAD |</span><br><span class="line">                                        +-------------+---------+   </span><br><span class="line">                           +------------+-----------------------+</span><br><span class="line">                           | TCP header |         PAYLOAD       |</span><br><span class="line">                           +------------+-----------------------+</span><br><span class="line">              +------------+------------------------------------+</span><br><span class="line">              | IP header  |              PAYLOAD               |</span><br><span class="line">              +------------+------------------------------------+</span><br><span class="line">+------------+--------------------------------------------------+</span><br><span class="line">| Eth header |                      PAYLOAD                     |</span><br><span class="line">+------------+--------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>TCP/IP 协议栈是双向的，即对于同一套协议，数据既可以被编码也可以被解码。</p>
<p>那么问题来了，是否可以抽象一种轻量的 Pipeline，实现类似网络协议栈双向数据流的处理能力，并且能够让用户定制化每层的处理逻辑？</p>
<h2 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h2><p>设计之前，先根据数据流划分功能模块，这里 <code>PIPE</code> 是数据和各个数据处理单元的调度者，<code>PIPE_UNIT_x</code> 是每层数据的处理单元，可以有多个，并且按顺序前后<strong>串联</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                +------------------ PIPE -------------------+</span><br><span class="line">[RAW_DATA] &lt;==&gt; | [PIPE_UNIT_1] &lt;==&gt; ... &lt;==&gt; [PIPE_UNIT_2] | &lt;==&gt; [ENCODED_DATA]</span><br><span class="line">                +-------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>用户可以实现自己的 <code>PIPE_UNIT</code> 来达到定制化处理逻辑的功能，也可以任意调换 <code>PIPE_UNIT</code> 的顺序来达到不同的处理效果。</p>
<h2 id="Pipe-设计"><a href="#Pipe-设计" class="headerlink" title="Pipe 设计"></a>Pipe 设计</h2><p><code>Pipe</code> 需要提供一个数据入口来启动链式处理流程：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PIPE_TYPE_ENCODE = <span class="string">'PIPE_TYPE_ENCODE'</span>;</span><br><span class="line"><span class="keyword">const</span> PIPE_TYPE_DECODE = <span class="string">'PIPE_TYPE_DECODE'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipe</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造 Pipe 时，传入的处理单元数组约定为 encode 顺序</span></span><br><span class="line">  <span class="keyword">constructor</span>(units) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>._encode_units = units;</span><br><span class="line">    <span class="keyword">this</span>._decode_units = [].concat(units).reverse();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 数据处理入口</span></span><br><span class="line">  feed(type, data) &#123;</span><br><span class="line">    <span class="keyword">const</span> units = type === PIPE_TYPE_ENCODE ? <span class="keyword">this</span>._encode_units : <span class="keyword">this</span>._decode_units;</span><br><span class="line">    <span class="keyword">if</span> (units.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> first = units[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (first.listenerCount(type) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 构建链式响应逻辑</span></span><br><span class="line">      <span class="keyword">const</span> last = units.reduce(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> &#123;</span><br><span class="line">        prev.on(type, (dt) =&gt; next._write(type, dt));</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">      &#125;);</span><br><span class="line">      last.on(type, (dt) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 最后一个 unit 完成之后 feed 的任务就结束了</span></span><br><span class="line">        <span class="keyword">this</span>.emit(type, dt);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 触发处理流程</span></span><br><span class="line">    first._write(type, data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="PipeUnit-接口设计"><a href="#PipeUnit-接口设计" class="headerlink" title="PipeUnit 接口设计"></a>PipeUnit 接口设计</h2><p><code>PipeUnit</code> 需要暴露编码（encode）和解码（decode）两个接口，考虑到处理单元可能异步执行，因此使用 <code>async</code> 黑膜法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PipeUnit</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> _write(type, data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === PIPE_TYPE_ENCODE) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(type, <span class="keyword">await</span> <span class="keyword">this</span>.encode(data));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(type, <span class="keyword">await</span> <span class="keyword">this</span>.decode(data));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编码接口</span></span><br><span class="line">  <span class="keyword">async</span> encode(data) &#123;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解码接口</span></span><br><span class="line">  <span class="keyword">async</span> decode(data) &#123;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现-PipeUnit"><a href="#实现-PipeUnit" class="headerlink" title="实现 PipeUnit"></a>实现 PipeUnit</h2><p>首先实现一个提供压缩、解压缩功能的 <code>PipeUnit</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">'zlib'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZipPipeUnit</span> <span class="keyword">extends</span> <span class="title">PipeUnit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> encode(data) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ZipPipeUnit::encode &lt;-'</span>, data);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      zlib.deflate(data, (err, buffer) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> decode(data) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ZipPipeUnit::decode &lt;-'</span>, data);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      zlib.unzip(data, (err, buffer) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面再实现一个提供 <code>AES</code> 对称加解密功能的 <code>PipeUnit</code>，这次采用同步执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoPipeUnit</span> <span class="keyword">extends</span> <span class="title">PipeUnit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编码实现</span></span><br><span class="line">  encode(plaintext) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'CryptoPipeUnit::encode &lt;-'</span>, plaintext);</span><br><span class="line">    <span class="keyword">const</span> cipher = crypto.createCipher(<span class="string">'aes192'</span>, <span class="string">'a password'</span>);</span><br><span class="line">    <span class="keyword">const</span> encrypted = cipher.update(plaintext);</span><br><span class="line">    <span class="keyword">return</span> Buffer.concat([encrypted, cipher.final()]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解码实现</span></span><br><span class="line">  decode(ciphertext) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'CryptoPipeUnit::decode &lt;-'</span>, ciphertext);</span><br><span class="line">    <span class="keyword">const</span> decipher = crypto.createDecipher(<span class="string">'aes192'</span>, <span class="string">'a password'</span>);</span><br><span class="line">    <span class="keyword">const</span> decrypted = decipher.update(ciphertext);</span><br><span class="line">    <span class="keyword">return</span> Buffer.concat([decrypted, decipher.final()]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实际运行"><a href="#实际运行" class="headerlink" title="实际运行"></a>实际运行</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自由组合处理单元</span></span><br><span class="line"><span class="keyword">const</span> units = [</span><br><span class="line">  <span class="keyword">new</span> ZipPipeUnit(),</span><br><span class="line">  <span class="keyword">new</span> CryptoPipeUnit(),</span><br><span class="line">  <span class="comment">// new CryptoPipeUnit(), // 再来一个也可以</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 来一个 pipe 对象</span></span><br><span class="line"><span class="keyword">const</span> pipe = <span class="keyword">new</span> Pipe(units);</span><br><span class="line"></span><br><span class="line">pipe.on(PIPE_TYPE_ENCODE, (data) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'encoded:'</span>, data);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">''</span>);</span><br><span class="line">  <span class="comment">// 解码</span></span><br><span class="line">  pipe.feed(PIPE_TYPE_DECODE, data);</span><br><span class="line">&#125;);</span><br><span class="line">pipe.on(PIPE_TYPE_DECODE, (data) =&gt; <span class="built_in">console</span>.log(<span class="string">'decoded:'</span>, data.toString()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编码</span></span><br><span class="line">pipe.feed(PIPE_TYPE_ENCODE, Buffer.from(<span class="string">'awesome nodejs'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出如下:</span></span><br><span class="line"><span class="comment">// ZipPipeUnit::encode &lt;- &lt;Buffer 61 77 65 73 6f 6d 65 20 6e 6f 64 65 6a 73&gt;</span></span><br><span class="line"><span class="comment">// CryptoPipeUnit::encode &lt;- &lt;Buffer 78 9c 4b 2c 4f 2d ce cf 4d 55 c8 cb 4f 49 cd 2a 06 00 2a 0c 05 95&gt;</span></span><br><span class="line"><span class="comment">// encoded: &lt;Buffer a9 61 bc 37 1a 4c 41 e8 20 63 d2 90 86 94 7b 48 98 b1 91 16 84 66 58 9b 6d 88 53 da 9b b9 18 fb&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CryptoPipeUnit::decode &lt;- &lt;Buffer a9 61 bc 37 1a 4c 41 e8 20 63 d2 90 86 94 7b 48 98 b1 91 16 84 66 58 9b 6d 88 53 da 9b b9 18 fb&gt;</span></span><br><span class="line"><span class="comment">// ZipPipeUnit::decode &lt;- &lt;Buffer 78 9c 4b 2c 4f 2d ce cf 4d 55 c8 cb 4f 49 cd 2a 06 00 2a 0c 05 95&gt;</span></span><br><span class="line"><span class="comment">// decoded: awesome nodejs</span></span><br></pre></td></tr></table></figure>
<p>可以看到，通过对 EventEmitter 简单的封装就可以实现双向数据 pipeline，同时支持异步单元操作。</p>
<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>功能实现了，性能又如何呢？抛开 <code>PipeUnit</code> 的业务实现，简单分析一下链式 EventEmitter 结构的性能影响因素，理论上很大程度取决于 EventEmitter 本身的性能，<code>Pipe::feed</code> 只在第一次被调用时构建响应链，之后的调用几乎不会有性能损失。</p>
<h3 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h3><p>Node.js 版本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; process.versions</span><br><span class="line">&#123; http_parser: &apos;2.8.0&apos;,</span><br><span class="line">  node: &apos;9.11.1&apos;,</span><br><span class="line">  v8: &apos;6.2.414.46-node.23&apos;,</span><br><span class="line">  uv: &apos;1.19.2&apos;,</span><br><span class="line">  zlib: &apos;1.2.11&apos;,</span><br><span class="line">  ares: &apos;1.13.0&apos;,</span><br><span class="line">  modules: &apos;59&apos;,</span><br><span class="line">  nghttp2: &apos;1.29.0&apos;,</span><br><span class="line">  napi: &apos;3&apos;,</span><br><span class="line">  openssl: &apos;1.0.2o&apos;,</span><br><span class="line">  icu: &apos;61.1&apos;,</span><br><span class="line">  unicode: &apos;10.0&apos;,</span><br><span class="line">  cldr: &apos;33.0&apos;,</span><br><span class="line">  tz: &apos;2018c&apos; &#125;</span><br></pre></td></tr></table></figure>
<p>下面分别考察 0 ~ 30000（每次递增 1000） 个 <code>PipeUnit</code> 实例的执行时间，来评估上述设计的性能表现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; performance &#125; = <span class="built_in">require</span>(<span class="string">'perf_hooks'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> payload = Buffer.alloc(<span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= <span class="number">30</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> units = <span class="built_in">Array</span>(i * <span class="number">1000</span>).fill().map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> PipeUnit());</span><br><span class="line"></span><br><span class="line">  performance.mark(<span class="string">'A_'</span> + i);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> pipe = <span class="keyword">new</span> Pipe(units);</span><br><span class="line">    pipe.on(PIPE_TYPE_ENCODE, (data) =&gt; &#123;</span><br><span class="line">      pipe.feed(PIPE_TYPE_DECODE, data);</span><br><span class="line">    &#125;);</span><br><span class="line">    pipe.on(PIPE_TYPE_DECODE, () =&gt; <span class="literal">null</span>);</span><br><span class="line">    pipe.feed(PIPE_TYPE_ENCODE, payload);</span><br><span class="line">  &#125;</span><br><span class="line">  performance.mark(<span class="string">'B_'</span> + i);</span><br><span class="line"></span><br><span class="line">  performance.measure(<span class="string">`<span class="subst">$&#123;units.length&#125;</span> units`</span>, <span class="string">'A_'</span> + i, <span class="string">'B_'</span> + i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> entries = performance.getEntriesByType(<span class="string">'measure'</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> &#123; name, duration &#125; <span class="keyword">of</span> entries) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;name&#125;</span>: <span class="subst">$&#123;duration&#125;</span>ms`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行4次，可以将结果绘制到一张图中：</p>
<p><img src="performance.png" alt=""></p>
<p>可以看到每次运行的结果高度一致，由上万个 <code>PipeUnit</code> 构成的链式 EventEmitter 能够以令人满意的效率完成运行。</p>
<p>不过出人意料的是，在特定数量的 <code>PipeUnit</code> 上总会出现尖峰，这可能和 V8 引擎的优化机制有关，作者能力有限，感兴趣的同学可以深挖原因。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2018/04/13/loading-webassembly-modules-efficiently/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/13/loading-webassembly-modules-efficiently/" itemprop="url">
                  高效加载 WebAssembly 模块
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-13T11:50:00+08:00">2018-04-13</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/13/loading-webassembly-modules-efficiently/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/13/loading-webassembly-modules-efficiently/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="【译文】高效加载-WebAssembly-模块"><a href="#【译文】高效加载-WebAssembly-模块" class="headerlink" title="【译文】高效加载 WebAssembly 模块"></a>【译文】高效加载 WebAssembly 模块</h1><blockquote><p>原文作者：Mathias Bynens<br>原文地址：<a href="https://developers.google.com/web/updates/2018/04/loading-wasm" target="_blank" rel="noopener">https://developers.google.com/web/updates/2018/04/loading-wasm</a></p></blockquote><p>在使用 WebAssembly 的时候，通常需要下载、编译、实例化一个模块，然后通过 JavaScript 调用由该模块导出的一些东西。这篇文章从一个常见但不是很优秀的代码片段开始，讨论几种可能的优化方法，最后得出最简单、最高效的通过 JavaScript 运行 WebAssembly 的方法。</p><blockquote><p>注意：诸如 Emscripten 的一些工具可以为你准备样板代码，因此你不需要自己编写 wasm 代码。如果你要更加细粒度地控制 WebAssembly 模块加载，那么请专注于下面的最佳实践吧。</p></blockquote><p>下面的代码片段完成了下载-编译-实例化的整个过程，尽管不是很优秀的方式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 别这么做</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">'fibonacci.wasm'</span>);</span><br><span class="line">  <span class="keyword">const</span> buffer = <span class="keyword">await</span> response.arrayBuffer();</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">new</span> WebAssembly.Module(buffer);</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> WebAssembly.Instance(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>注意我们是如何使用 <code>new WebAssembly.Module(buffer)</code> 将响应数据转换成一个模块的。这是一个同步 API，意味着它在完成之前会阻塞主线程。为了防止滥用，Chrome 禁止在超过 4KB 的 buffer 上使用 <code>WebAssembly.Module</code>。为了避免大小限制，我们可以用 <code>await WebAssembly.compile(buffer)</code> 来代替：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">'fibonacci.wasm'</span>);</span><br><span class="line">  <span class="keyword">const</span> buffer = <span class="keyword">await</span> response.arrayBuffer();</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">await</span> WebAssembly.compile(buffer);</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> WebAssembly.Instance(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p><code>await WebAssembly.compile(buffer)</code> 仍然不是一个优秀的方式，不过姑且先这样。</p>
<p>在修改后的代码片段中，几乎所有的操作都是异步的，因为 <code>await</code> 使之变得很清晰。只有 <code>new WebAssembly.Instance(module)</code> 是个例外。为了一致性，我们可以用异步 <code>WebAssembly.instantiate(module)</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">'fibonacci.wasm'</span>);</span><br><span class="line">  <span class="keyword">const</span> buffer = <span class="keyword">await</span> response.arrayBuffer();</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">await</span> WebAssembly.compile(buffer);</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">await</span> WebAssembly.instantiate(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>让我们回顾一下我之前提到的对于 <code>compile</code> 的优化。利用 <a href="https://v8project.blogspot.com/2018/02/v8-release-65.html" target="_blank" rel="noopener">流式编译</a>，浏览器可以在模块数据下载过程中就开始编译 WebAssembly 模块。因为下载和编译过程是并发的，特别是对于大模块，这样将会更快。</p>
<p><img src="streaming.png" alt=""></p>
<p>使用 <code>WebAssembly.compileStreaming</code> 替换 <code>WebAssembly.compile</code> 可以开启这个功能。这么做之后还可以避免产生中间数据，因为现在我们可以直接传递由 <code>await fetch(url)</code> 返回的 <code>Response</code> 实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">'fibonacci.wasm'</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">await</span> WebAssembly.compileStreaming(response);</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">await</span> WebAssembly.instantiate(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：服务端必须经过配置能够支持以 <strong>Content-Type: application/wasm</strong> 头发送 <strong>.wasm</strong> 文件。在之前的例子中，我们将响应数据当做 arraybuffer 传递，因此不需要进行 MIME 类型检查。</p>
</blockquote>
<p><code>WebAssembly.compileStreaming</code> API 也能接收一个 resolve 为 <code>Response</code> 的 promise 实例。如果你没在别的地方使用 <code>response</code>，你可以直接传递由 <code>fetch</code> 返回的 promise 对象，而不需要 <code>await</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> fetchPromise = fetch(<span class="string">'fibonacci.wasm'</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">await</span> WebAssembly.compileStreaming(fetchPromise);</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">await</span> WebAssembly.instantiate(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>如果你也没在其他地方使用 <code>fetch</code> 的结果，你甚至也可以直接传递它：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">await</span> WebAssembly.compileStreaming(</span><br><span class="line">    fetch(<span class="string">'fibonacci.wasm'</span>));</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">await</span> WebAssembly.instantiate(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>我个人认为将其单独成行可读性更好。</p>
<p>想知道我们是如何将响应数据编译为模块然后实例化的？事实证明，<code>WebAssembly.instantiate</code> 可以一步到位。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> fetchPromise = fetch(<span class="string">'fibonacci.wasm'</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="built_in">module</span>, instance &#125; = <span class="keyword">await</span> WebAssembly.instantiateStreaming(fetchPromise);</span><br><span class="line">  <span class="comment">// 稍后创建 instance 对象:</span></span><br><span class="line">  <span class="keyword">const</span> otherInstance = <span class="keyword">await</span> WebAssembly.instantiate(<span class="built_in">module</span>); </span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>如果你只需要 instance 对象，那没理由再保留 module 对象，简化代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是加载 WebAssembly 的建议方式。</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> fetchPromise = fetch(<span class="string">'fibonacci.wasm'</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; instance &#125; = <span class="keyword">await</span> WebAssembly.instantiateStreaming(fetchPromise);</span><br><span class="line">  <span class="keyword">const</span> result = instance.exports.fibonacci(<span class="number">42</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>总结一下我们所用过的优化方法：</p>
<ul>
<li>使用异步 API 来避免阻塞主线程</li>
<li>使用流式 API 来加快 WebAssembly 模块的编译和实例化速度</li>
<li>不要写你不需要的代码</li>
</ul>
<p>尽情享用 WebAssembly 吧！</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2018/03/12/react-16-3-context-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/12/react-16-3-context-api/" itemprop="url">
                  React 16.3 Context API 实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-12T00:00:00+08:00">2018-03-12</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/12/react-16-3-context-api/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/12/react-16-3-context-api/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="React-16-3-Context-API-实践"><a href="#React-16-3-Context-API-实践" class="headerlink" title="React 16.3 Context API 实践"></a>React 16.3 Context API 实践</h1><h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>本文简单介绍了 Context API 的提出背景、API 设计和用法；之后比较了 React-Redux 的设计；然后提出了一种基于 Context API 的二次封装；最后再将二次封装和 mobx-react 进行了比较。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>React 项目组成员 <a href="https://github.com/acdlite" target="_blank" rel="noopener">@acdlite</a> 于 2017-12-05 提出关于新 Context API 的 <a href="https://github.com/reactjs/rfcs/pull/2" target="_blank" rel="noopener">RFC</a>。</p><p>实际上 Context 在 React 的早期版本中就已经存在，但不能解决当 <code>shouldComponentUpdate</code> 返回 <code>false</code> 时，组件无法响应 context 的改变的问题。由于 <code>shouldComponentUpdate</code> 常用于性能优化，被大量开源库或框架广泛使用，因此原版的 Context 变得十分鸡肋，新的 Context API 很好地解决了这一问题。</p><h2 id="Context-API"><a href="#Context-API" class="headerlink" title="Context API"></a>Context API</h2><p>首先安装 16.3.x 版本的 <code>react</code> 及 <code>react-dom</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add react@next react-dom@next</span><br></pre></td></tr></table></figure>
<p>来看一个简单的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; createContext &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Provider, Consumer &#125; = createContext(&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// const &#123; date &#125; = this.props;</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Consumer&gt;</span><br><span class="line">          <span class="comment">// 子组件在任意位置通过 &lt;Consumer&gt; 消费顶层给 &lt;Provider&gt; 传入的 value，</span></span><br><span class="line">          <span class="comment">// 感知 value 的变化来重新渲染该区块。</span></span><br><span class="line">          &#123;(&#123; date &#125;) =&gt; <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;date&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#125;</span><br><span class="line">        &lt;<span class="regexp">/Consumer&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  state = &#123;</span><br><span class="line">    date: <span class="string">''</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 在父组件中更新状态</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">date</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().toString() &#125;);</span><br><span class="line">    &#125;, <span class="number">1e3</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Provider value=&#123;<span class="keyword">this</span>.state&#125;&gt;</span><br><span class="line">        <span class="comment">// 父组件不用给子组件显式传入任何数据</span></span><br><span class="line">        &lt;Child/&gt;</span><br><span class="line">      &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(&lt;App/</span>&gt;, <span class="built_in">document</span>.querySelector(<span class="string">'#root'</span>));</span><br></pre></td></tr></table></figure>
<p>使用 Context API 最大的好处就是解决深层嵌套组件层层传递 props 的问题。但这样做也存在一个问题： state 的被保存在 <code>&lt;App&gt;</code> 中，更新状态时必须调用 <code>&lt;App&gt;</code> 的 <code>this.setState()</code>，如果子组件需要更新 <code>state</code>，那么需要通过 <code>&lt;Provider&gt;</code> 向下传递封装了 <code>this.setState()</code> 的回调函数:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;Provider value=&#123;&#123; </span><br><span class="line">  state: <span class="keyword">this</span>.state,</span><br><span class="line">  actions: &#123; </span><br><span class="line">    doSomething(newState) &#123; <span class="keyword">this</span>.setState(newState); &#125;</span><br><span class="line">  &#125;&#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">  &lt;Child/&gt;</span><br><span class="line">&lt;<span class="regexp">/Provider&gt;</span></span><br></pre></td></tr></table></figure>
<p>之后，子组件要求改变状态时，在 <code>&lt;Consumer&gt;</code> 中调用该回调方法即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Consumer&gt;</span><br><span class="line">  &#123;(&#123; <span class="attr">state</span>: &#123; date &#125;, actions &#125;) =&gt; </span><br><span class="line">    &lt;button onClick=&#123;() =&gt; actions.doSomething(...)&#125;&gt;&#123;date&#125;&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>Consumer&gt;</span><br></pre></td></tr></table></figure>
<p>另有一个问题是如何实现在 <strong>组件外</strong> 更新状态，让组件也能响应状态变化？</p>
<p>这样的需求通常在应用需要与第三方库交互时会遇到，举一个实际的例子：</p>
<p>Q: 一个 web 应用使用 websocket 做数据交换，我们需要在页面上<strong>实时显示</strong> websocket 连接的延迟：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ws.js</span></span><br><span class="line"><span class="keyword">const</span> ws = io.connect(<span class="string">'/'</span>);</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'pong'</span>, (latency) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 如何将 latency 渲染到组件里？</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>先前例子中将 state 内化的方式显然不可行了，这个时候联想到 Redux，利用它全局 store 的设计，借助 <code>store.dispatch</code> 就可以实现上面的需求了。</p>
<h3 id="Redux-React-Redux"><a href="#Redux-React-Redux" class="headerlink" title="Redux/React-Redux"></a>Redux/React-Redux</h3><p><code>React-Redux</code> 是对 React 老版本 Context 的封装，它允许子组件通过 <code>connect</code> 方法建立对 store 中状态变化的响应，下面是一个简单的 Redux 应用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个 reducer 来处理 action</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state = &#123; date: <span class="string">''</span> &#125;, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'UPDATE_DATE'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">date</span>: action.date &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个全局 store 来存储状态</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 发一个 action 来更新 store</span></span><br><span class="line">      store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'UPDATE_DATE'</span>, <span class="attr">date</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().toString() &#125;);</span><br><span class="line">    &#125;, <span class="number">1e3</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">        <span class="comment">// 父组件不用给子组件显式传入任何数据</span></span><br><span class="line">        &lt;Child/&gt;</span><br><span class="line">      &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(&lt;App/</span>&gt;, <span class="built_in">document</span>.querySelector(<span class="string">'#root'</span>));</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// child.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">date</span>: state.date &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 connect 来感知全局 store 的变化</span></span><br><span class="line">@connect(mapStateToProps, <span class="literal">null</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;&#123;<span class="keyword">this</span>.props.date&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看到在 Redux 的套路中，完成一次 <code>状态更新</code> 需要 dispatch 一个 action 到 reducer，这个过程同时牵扯到三个概念，有些复杂；而在 Context API 的套路中，完成一次 <code>状态更新</code> 只需要 <code>setState(...)</code> 就够了，但单纯的 Context API 无法解决先前提到的 <strong>组件外</strong> 更新状态的问题。</p>
<h3 id="对-Context-API-的简单封装"><a href="#对-Context-API-的简单封装" class="headerlink" title="对 Context API 的简单封装"></a>对 Context API 的简单封装</h3><p>下面对 Context API 进行二次封装，让它支持类似 Redux 全局 store 的特性，但用法又比 Redux 更加简单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; createContext &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> AppContext = createContext();</span><br><span class="line"></span><br><span class="line"><span class="comment">// self 是对 &lt;Provider&gt; 组件实例的引用</span></span><br><span class="line"><span class="keyword">let</span> self = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  state = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    self = <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;AppContext.Provider value=&#123;<span class="keyword">this</span>.state&#125;&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.props.children&#125;</span><br><span class="line">      &lt;<span class="regexp">/AppContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const Consumer = AppContext.Consumer;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function getState() &#123;</span></span><br><span class="line"><span class="regexp">  if (self) &#123;</span></span><br><span class="line"><span class="regexp">    return self.state;</span></span><br><span class="line"><span class="regexp">  &#125; else &#123;</span></span><br><span class="line"><span class="regexp">    console.warn('cannot getState() because &lt;Provider&gt; is not initialized');</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function setState(...args) &#123;</span></span><br><span class="line"><span class="regexp">  if (self) &#123;</span></span><br><span class="line"><span class="regexp">    self.setState(...args);</span></span><br><span class="line"><span class="regexp">  &#125; else &#123;</span></span><br><span class="line"><span class="regexp">    console.warn('cannot setState() because &lt;Provider&gt; is not initialized');</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function createStore() &#123;</span></span><br><span class="line"><span class="regexp">  return &#123; getState, setState &#125;;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export &#123; Provider, Consumer, createStore &#125;;</span></span><br></pre></td></tr></table></figure>
<p>用法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider, Consumer, createStore &#125; <span class="keyword">from</span> <span class="string">'./context'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新建一个全局 store</span></span><br><span class="line"><span class="keyword">const</span> store = createStore();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;p&gt;<span class="number">1.</span> 通过回调参数获取最新状态&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Consumer&gt;</span></span><br><span class="line"><span class="regexp">          &#123;(&#123; date &#125;) =&gt; &lt;div&gt;&#123;date&#125;&lt;/</span>div&gt;&#125;</span><br><span class="line">        &lt;<span class="regexp">/Consumer&gt;</span></span><br><span class="line"><span class="regexp">        &lt;p&gt;2. 通过 store.getState() 获取所有状态&lt;/</span>p&gt;</span><br><span class="line">        &lt;Consumer&gt;</span><br><span class="line">          &#123;() =&gt; <span class="xml"><span class="tag">&lt;<span class="name">pre</span>&gt;</span>&#123;JSON.stringify(store.getState(), null, 2)&#125;<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span>&#125;</span><br><span class="line">        &lt;<span class="regexp">/Consumer&gt;</span></span><br><span class="line"><span class="regexp">        &lt;p&gt;3. 通过 store.setState() 更新状态&lt;/</span>p&gt;</span><br><span class="line">        &lt;Consumer&gt;</span><br><span class="line">          &#123;() =&gt; <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> store.setState(&#123; foo: new Date().toString() &#125;)&#125;&gt;子组件触发状态更新<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>&#125;</span><br><span class="line">        &lt;<span class="regexp">/Consumer&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="comment">// 父组件触发状态更新</span></span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      store.setState(&#123; <span class="attr">date</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().toString() &#125;);</span><br><span class="line">    &#125;, <span class="number">1e3</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">// 现在 &lt;Provider&gt; 不需要任何参数了</span></span><br><span class="line">      &lt;Provider&gt;</span><br><span class="line">        &lt;Child/&gt;</span><br><span class="line">      &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(&lt;App/</span>&gt;, <span class="built_in">document</span>.querySelector(<span class="string">'#root'</span>));</span><br></pre></td></tr></table></figure>
<p>现在在应用的任意位置调用 <code>store.setState()</code> 方法，就能更新组件的状态了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ws.js</span></span><br><span class="line"><span class="keyword">const</span> ws = io.connect(<span class="string">'/'</span>);</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'pong'</span>, (latency) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 如何将 latency 渲染到组件里？</span></span><br><span class="line">  store.setState(&#123; latency &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="和-mobx-mobx-react-进行比较"><a href="#和-mobx-mobx-react-进行比较" class="headerlink" title="和 mobx/mobx-react 进行比较"></a>和 mobx/mobx-react 进行比较</h3><p>MobX 基于观察者模式，通过 mobx-react 封装后许多地方和 Context API 类似，下面是官方提供的一个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">     <span class="keyword">return</span> (</span><br><span class="line">         &lt;div&gt;</span><br><span class="line">            &#123;<span class="keyword">this</span>.props.person.name&#125;</span><br><span class="line">            &lt;Observer&gt;</span><br><span class="line">                &#123;() =&gt; <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;this.props.person.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>&#125;</span><br><span class="line">            &lt;<span class="regexp">/Observer&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">     )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = observable(&#123; <span class="attr">name</span>: <span class="string">"John"</span> &#125;)</span><br><span class="line"></span><br><span class="line">React.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> <span class="attr">person</span>=<span class="string">&#123;person&#125;</span> /&gt;</span>, document.body)</span></span><br><span class="line"><span class="xml">person.name = "Mike" // will cause the Observer region to re-render</span></span><br></pre></td></tr></table></figure>
<p>在 mobx-react 的套路中，组件可以通过 <code>&lt;Observer&gt;</code> 消费由 <code>observable()</code> 创建出来的对象，直接修改该对象中的键值可以实现组件的重新渲染。</p>
<p>二次封装后的 Context API 相比 mobx-react 用法相近，但 mobx 得益于 setter/getter Hooks 具有更直观的状态改变方式。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://github.com/acdlite/rfcs/blob/new-version-of-context/text/0000-new-version-of-context.md" target="_blank" rel="noopener">https://github.com/acdlite/rfcs/blob/new-version-of-context/text/0000-new-version-of-context.md</a></li>
<li><a href="https://github.com/reactjs/rfcs/pull/2" target="_blank" rel="noopener">https://github.com/reactjs/rfcs/pull/2</a></li>
<li><a href="https://github.com/facebook/react/pull/11818" target="_blank" rel="noopener">https://github.com/facebook/react/pull/11818</a></li></ul>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2016/10/11/qnimate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/11/qnimate/" itemprop="url">
                  Qnimate, an animated colorful voronoi diagram powered by d3.js
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-11T14:28:57+08:00">2016-10-11</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/11/qnimate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/11/qnimate/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="qnimate"><a href="#qnimate" class="headerlink" title="qnimate"></a>qnimate</h1><p>An animated colorful <a href="https://en.wikipedia.org/wiki/Voronoi_diagram" target="_blank" rel="noopener">Voronoi diagram</a><br>powered by <a href="https://github.com/d3/d3" target="_blank" rel="noopener">d3</a>.</p><h2 id="Live-demo"><a href="#Live-demo" class="headerlink" title="Live demo"></a>Live demo</h2><p><a href="https://micooz.github.io/qnimate" target="_blank" rel="noopener">https://micooz.github.io/qnimate</a></p><h2 id="Try-it"><a href="#Try-it" class="headerlink" title="Try it!"></a>Try it!</h2><p>Install via npm:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/micooz/qnimate</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> qnimate &amp;&amp; npm i</span></span><br></pre></td></tr></table></figure>
<p>Run in development:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm start</span></span><br></pre></td></tr></table></figure>
<p>Build and bundle:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run build:prod</span></span><br></pre></td></tr></table></figure>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p><strong>HTML</strong>:</p>
<pre><code>&lt;div id=&quot;&quot;playground&quot;&quot;&gt;&lt;/div&gt;
</code></pre><p><strong>js</strong>:</p>
<pre><code>&lt;script src=&quot;&quot;qnimate.min.js&quot;&quot;&gt;&lt;/script&gt;
</code></pre><p><code>Qnimate</code> will be exposed to <code>window</code>, create an instance of <code>Qnimate</code>, pass an option object and then call <code>run()</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'DOMContentLoaded'</span>, <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> qnimate = <span class="keyword">new</span> Qnimate(&#123;</span><br><span class="line">    id: <span class="string">'playground'</span>,</span><br><span class="line">    width: <span class="number">960</span>,</span><br><span class="line">    height: <span class="number">500</span>,</span><br><span class="line">    vertices: <span class="number">40</span></span><br><span class="line">  &#125;);</span><br><span class="line">  qnimate.run();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Acknowledgments"><a href="#Acknowledgments" class="headerlink" title="Acknowledgments"></a>Acknowledgments</h2><p><code>d3.voronoi</code> - <a href="https://github.com/d3/d3-voronoi" target="_blank" rel="noopener">https://github.com/d3/d3-voronoi</a></p>
<h2 id="Known-issues"><a href="#Known-issues" class="headerlink" title="Known issues"></a>Known issues</h2><ul>
<li>New triangle appears suddenly.</li>
<li>White triangle appears from time to time.</li>
</ul>
<h2 id="Any-advice"><a href="#Any-advice" class="headerlink" title="Any advice?"></a>Any advice?</h2><p>Send me <a href="https://github.com/micooz/qnimate/issues" target="_blank" rel="noopener">issue</a>.</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2016/07/26/how-to-disable-text-selection-in-svg/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/26/how-to-disable-text-selection-in-svg/" itemprop="url">
                  How to disable text selection in svg
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-26T00:00:00+08:00">2016-07-26</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/07/26/how-to-disable-text-selection-in-svg/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/26/how-to-disable-text-selection-in-svg/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>In sass style:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">text</span> &#123;</span><br><span class="line">  <span class="attribute">user-select</span>: none;</span><br><span class="line">  </span><br><span class="line">  &amp;::selection &#123;</span><br><span class="line">    <span class="selector-tag">background</span>: <span class="selector-tag">none</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2016/06/16/d3-stereotype/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/16/d3-stereotype/" itemprop="url">
                  D3绘图套路
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-16T16:46:12+08:00">2016-06-16</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/16/d3-stereotype/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/06/16/d3-stereotype/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote><p>接触D3三天，发现有些套路可以反复运用，所以记录一下。</p></blockquote><p><code>D3</code>相比其他图表库，学习成本较高。但最为灵活，需要使用者精雕细琢图形的每个细节。D3处处体现了<strong>函数式</strong>的编程思维。</p><p><strong>NOTE:</strong> 这里所用D3版本是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;dependencies&quot;&quot;: &#123;</span><br><span class="line">  &quot;&quot;d3&quot;&quot;: &quot;&quot;^4.0.0-alpha.49&quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面以一个简单的横纵坐标图为例。</p>
<h2 id="①-定义高宽"><a href="#①-定义高宽" class="headerlink" title="① 定义高宽"></a>① 定义高宽</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> margin = &#123;<span class="attr">left</span>: <span class="number">70</span>, <span class="attr">top</span>: <span class="number">20</span>, <span class="attr">right</span>: <span class="number">20</span>, <span class="attr">bottom</span>: <span class="number">50</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> svgWidth = <span class="number">800</span>;</span><br><span class="line"><span class="keyword">var</span> svgHeight = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> graphWidth = svgWidth - margin.left - margin.right;</span><br><span class="line"><span class="keyword">var</span> graphHeight = svgHeight - margin.top - margin.bottom;</span><br></pre></td></tr></table></figure>
<p>这一步实际上比较重要，图形高宽参数会在后面绘图中常常用到。</p>
<h2 id="②-创建svg"><a href="#②-创建svg" class="headerlink" title="② 创建svg"></a>② 创建svg</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> svg = d3.select(<span class="string">'.container'</span>).append(<span class="string">'svg'</span>)</span><br><span class="line">    .attr(<span class="string">'width'</span>, svgWidth)</span><br><span class="line">    .attr(<span class="string">'height'</span>, svgHeight);</span><br></pre></td></tr></table></figure>
<p>这里可以直接在html中放一个<code>&lt;svg&gt;</code>，但为了可移植性，用脚本生成。</p>
<h2 id="③-创建绘制区域"><a href="#③-创建绘制区域" class="headerlink" title="③ 创建绘制区域"></a>③ 创建绘制区域<g></g></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> graph = svg.append(<span class="string">'g'</span>)</span><br><span class="line">    .attr(<span class="string">'width'</span>, graphWidth)</span><br><span class="line">    .attr(<span class="string">'height'</span>, graphHeight)</span><br><span class="line">    .attr(<span class="string">'transform'</span>, <span class="string">'translate('</span> + margin.left + <span class="string">','</span> + margin.top + <span class="string">')'</span>);</span><br></pre></td></tr></table></figure>
<p><code>&lt;g&gt;</code>中将包含所有图形元素（坐标轴、标签、线条……），现在svg树是这样的：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">g</span>&gt;</span><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="④-设置X、Y的图形坐标范围"><a href="#④-设置X、Y的图形坐标范围" class="headerlink" title="④ 设置X、Y的图形坐标范围"></a>④ 设置X、Y的图形坐标范围</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = d3.scaleTime()</span><br><span class="line">    .range([<span class="number">0</span>, graphWidth]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> y = d3.scaleLinear()</span><br><span class="line">    .range([graphHeight, <span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<p>这个时候由于数据还没获取，只能先设置他们的<strong>图形坐标</strong>范围，注意这个<strong>不是</strong>数据的定义域。</p>
<p>这个两个<code>函数</code>通常有两个用途，以<code>x</code>为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> px = x(data); <span class="comment">// 根据数据值计算对应的x坐标值</span></span><br><span class="line"><span class="keyword">var</span> data = x.invert(px); <span class="comment">// 根据x坐标值反算对应的数据值</span></span><br></pre></td></tr></table></figure>
<h2 id="⑤-获取数据"><a href="#⑤-获取数据" class="headerlink" title="⑤ 获取数据"></a>⑤ 获取数据</h2><p>一般情况下都是从远端取回特定格式的数据，这是个异步过程：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d3.csv(<span class="string">'data.csv'</span>, parser, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// data</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>D3很人性化的给你留了个格式化数据的地方<code>parser</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parser</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    date: d3.timeParse(<span class="string">'%b %Y'</span>)(d.date),</span><br><span class="line">    value: +(d.price)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>D3取出数据的每一行，依次传入该函数，然后可以返回你需要的格式化数据，最后以数组形成出现在<code>data</code>变量中。</p>
<h2 id="⑥-设置X、Y的值域"><a href="#⑥-设置X、Y的值域" class="headerlink" title="⑥ 设置X、Y的值域"></a>⑥ 设置X、Y的值域</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// value domain of x and y</span></span><br><span class="line">x.domain(d3.extent(data, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> d.date;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">y.domain([<span class="number">0</span>, d3.max(data, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> d.value;</span><br><span class="line">&#125;)]);</span><br></pre></td></tr></table></figure>
<p>现在可以给x和y设置值域了，值域类型可以很灵活，上面设置x的值域是一个时间范围。</p>
<h2 id="⑦-开始绘制"><a href="#⑦-开始绘制" class="headerlink" title="⑦ 开始绘制"></a>⑦ 开始绘制</h2><p>接下来就是构思你图形的各个部分了，坐标轴、标签、图形内容等等，也是逐步生成一个完整<code>svg</code>的过程。为了简便起见，这里不会贴出冗余代码。</p>
<p>绘制X轴：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// X、Y轴可以利用D3的axisXXXXXX函数简单创建，</span></span><br><span class="line"><span class="comment">// 它会把坐标轴的每个数据标签、包括刻度线都为你生成好</span></span><br><span class="line">graph.append(<span class="string">'g'</span>)</span><br><span class="line">    .attr(<span class="string">'class'</span>, <span class="string">'.x-axis'</span>)</span><br><span class="line">    .attr(<span class="string">'transform'</span>, <span class="string">'translate(-1,'</span> + graphHeight + <span class="string">')'</span>)</span><br><span class="line">    .call(d3.axisBottom(x));</span><br></pre></td></tr></table></figure>
<p>绘制折线：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个线段生成器，会根据绑定数据，通过x和y访问器计算每个点的坐标位置</span></span><br><span class="line"><span class="keyword">var</span> line = d3.line()</span><br><span class="line">    .x(<span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> x(d.date)</span><br><span class="line">    &#125;)</span><br><span class="line">    .y(<span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> y(d.value)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 折线图可以用svg中的&lt;path&gt;并设置其d属性来绘制</span></span><br><span class="line"><span class="comment">// line函数需要一个点集来生成一个字符串，这个字符串可以直接填充&lt;path&gt;的d属性</span></span><br><span class="line"><span class="comment">// 为了使线段可见，还需要设置其stroke和stroke-width样式。</span></span><br><span class="line"><span class="keyword">var</span> path = graph.append(<span class="string">'path'</span>)</span><br><span class="line">    .attr(<span class="string">'d'</span>, line(data));</span><br></pre></td></tr></table></figure>
<p>至此，就可以看到一个基本图形了。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2016/06/14/d3-zoom/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/14/d3-zoom/" itemprop="url">
                  【记坑】关于d3.zoom
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-14T14:28:57+08:00">2016-06-14</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/14/d3-zoom/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/06/14/d3-zoom/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote><p>D3.js的最新v4版提供了d3.zoom模块，用它可以给svg图形增加缩放/移动的特性，但通过非鼠标/触控的方式改变图形的位置和缩放比例后，d3.zoom的行为就变得不正常了。本文给出一个解决方法。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 初始化一个zoom行为</span></span><br><span class="line"><span class="keyword">const</span> zoom = d3.zoom();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 设置zoom行为参数</span></span><br><span class="line">zoom.scaleExtent([<span class="number">.5</span>, <span class="number">5</span>]);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 添加三个事件监听器</span></span><br><span class="line">zoom.on(<span class="string">'start'</span>, () =&gt; &#123;...&#125;);</span><br><span class="line">zoom.on(<span class="string">'zoom'</span>, zoom);</span><br><span class="line">zoom.on(<span class="string">'end'</span>, () =&gt; &#123;...&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 应用行为</span></span><br><span class="line">g.call(zoom);</span><br></pre></td></tr></table></figure>
<p>我们一般会关注<code>zoom</code>事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> zoom = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// d3自动计算的transform值会放在d3.event里</span></span><br><span class="line">  container.attr(<span class="string">'transform'</span>, d3.event.transform);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>有趣的是，如果我们在其他地方主动设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container.attr(<span class="string">'transform'</span>, <span class="string">'translate(10, 10)'</span>);</span><br></pre></td></tr></table></figure>
<p>再用鼠标或者触控板调整图形时，zoom行为并不会从(10, 10)位置开始计算下一个<code>d3.event.transform</code>，zoom行为似乎<code>自己保存</code>了上一次的transform，而不关心我们设置到<code>container</code>上的transform。</p>
<p>结果就是我们用attr设置的transform其实是<code>临时的</code>。</p>
<p>如果查看应用了zoom行为的宿主元素（这里是<code>g</code>）的属性，会发现其Element上有一个<code>__zoom: Transform</code>，这个玩意儿每次走<code>zoom</code>方法的时候都会变化，这正是zoom自己保存的transform对象。</p>
<p>所以我们在主动设置transform后，只需要想办法更新这个__zoom就可以<code>骗过</code>zoom行为，让它下一次调用zoom()事，从我们设置的值开始计算。</p>
<p>查阅文档：</p>
<p><a href="https://github.com/d3/d3-zoom/blob/master/README.md#zoom_transform" target="_blank" rel="noopener">https://github.com/d3/d3-zoom/blob/master/README.md#zoom_transform</a></p>
<p><a href="https://github.com/d3/d3-zoom/blob/master/README.md#transform_scale" target="_blank" rel="noopener">https://github.com/d3/d3-zoom/blob/master/README.md#transform_scale</a></p>
<p>可以这样设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义transform</span></span><br><span class="line">container.attr(<span class="string">'transform'</span>, <span class="string">'translate(10, 10)'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化一个空的Transform对象，这一点文档没说明怎么构造一个Transform对象</span></span><br><span class="line"><span class="keyword">const</span> transform = d3.zoomTransform(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 填充&#123;x, y&#125;</span></span><br><span class="line">    .translate(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意一定要设置在.call(zoom)的元素上，它才有'__zoom'</span></span><br><span class="line">d3.zoom().transform(g, transform);</span><br></pre></td></tr></table></figure>
<p>之后d3触发zoom回调之前会取g的__zoom计算下一次的transform，这个transform才是我们想要的。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2016/05/12/link-in-docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/12/link-in-docker/" itemprop="url">
                  link in docker
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-12T00:00:00+08:00">2016-05-12</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/05/12/link-in-docker/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/05/12/link-in-docker/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="–link-in-docker"><a href="#–link-in-docker" class="headerlink" title="–link in docker"></a>–link in docker</h1><p>容器A通过–link选项使用容器B的某个服务，<code>docker-compose.yml</code> 配置如下：</p><pre><code>A:
  image: image_a
  links:
    - B:B
  ...

B:
  image: image_b
  ...
</code></pre><p>当容器B被重启后，A的link不会被自动更新，要一并重启A才行：</p><pre><code>$ docker-compose restart B # A doesn&apos;t work
$ docker-compose restart A # it works well
</code></pre>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2016/05/10/webpack-dev-server-best-practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/10/webpack-dev-server-best-practice/" itemprop="url">
                  webpack-dev-server 最佳实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-10T00:00:00+08:00">2016-05-10</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/05/10/webpack-dev-server-best-practice/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/05/10/webpack-dev-server-best-practice/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p><a href="https://github.com/webpack/webpack-dev-server" target="_blank" rel="noopener">webpack-dev-server</a> 是用express和websocket实现的一套在开发环境下前端自动更新的工具。</p><p>webpack-dev-server提供CLI接口，读取传入的webpack.config.js配置文件，根据webpack配置，建立一个静态服务器，供前端加载静态资源，其中有一个关键附加脚本是 <code>webpack-dev-server.js</code>，位于PATH根路径，即 <code>/webpack-dev-server.js</code>，其中存放着websocket客户端。</p><h2 id="一般使用方法"><a href="#一般使用方法" class="headerlink" title="一般使用方法"></a>一般使用方法</h2><p>可以通过下面的命令运行webpack-dev-server：</p><pre><code>$ node node_modules/.bin/webpack-dev-server --config webpack/dev.config.js --inline --profile --colors --watch --display-error-details --display-cached
</code></pre><p>参数说明参考：<a href="http://webpack.github.io/docs/webpack-dev-server.html#webpack-dev-server-cli" target="_blank" rel="noopener">这里</a></p><p>执行后会自动运行webpack进行打包等一系列操作。</p><p>在webpack配置文件中只需添加一个 <code>devServer</code> 配置项即可定义webpack-dev-server的行为：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  port: <span class="number">3000</span>,</span><br><span class="line">  host: <span class="string">'localhost'</span>,</span><br><span class="line">  historyApiFallback: <span class="literal">true</span>,</span><br><span class="line">  quiet: <span class="literal">false</span>,</span><br><span class="line">  watchOptions: &#123;</span><br><span class="line">    aggregateTimeout: <span class="number">300</span>,</span><br><span class="line">    poll: <span class="number">1000</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>在这个例子中，webpack-dev-server会在本地<strong>3000</strong>端口上启动一个静态服务器，服务器serve的目录是webpack的必选配置 <code>output.path</code>，这是一个绝对路径。</p>
<h2 id="一些问题？"><a href="#一些问题？" class="headerlink" title="一些问题？"></a>一些问题？</h2><p>请考虑下面这个问题：</p>
<p>我有一个网站项目，分模块，每个模块是一个node项目，且每个模块可以<strong>独立存在</strong>（启动，调试，运行），它们有些用到了webpack-dev-server。</p>
<p>再次强调每个模块相互独立，它们之间的耦合方式只有一种：<strong>请求代理</strong>。</p>
<p>现在假设模块A作为API服务器，监听3000端口；模块B作为应用服务器，要提供资源给浏览器，于是用webpack-dev-server在端口3001的 <code>/</code> 上建立了静态服务器。模块B还要从模块A存取数据，那么必定存在从3001跨域请求到3000的问题，消除这个问题有多种解决办法：</p>
<ol>
<li>在A上设置 <code>Access-Control-Allow-Origin</code> 为B的域。</li>
<li>在A、B上层建立代理服务器，屏蔽端口限制。</li>
</ol>
<p>不深入讨论上面的方法，现在假设我们<strong>采用方法二</strong>解决了跨域请求问题，然后我们再考虑一下接下来的一个问题：</p>
<p>假设存在模块C，和B十分类似，也属于应用服务器；如果B和C存在同名资源，比如 <code>main.js</code>，访问该资源就会引发冲突，因为两个模块都在 <code>/</code> 上建立了静态服务器，而这又符合每个模块可以<strong>独立存在</strong>的先决条件：</p>
<pre><code>// B
http://localhost/B/index.html
http://localhost/main.js
// C
http://localhost/C/index.html
http://localhost/main.js // 哪个 main.js ?
</code></pre><p>解决办法看似很明显：</p>
<pre><code>// B
http://localhost/B/index.html
http://localhost/B/main.js
// C
http://localhost/C/index.html
http://localhost/C/main.js // everyone is happy
</code></pre><p>但这又破坏了每个模块的独立性，我希望单独启动C时，C总能从 <code>/</code> 上获取资源，而不是 <code>/C/...</code> 这么冗余。</p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>问题就出在 <code>webpack-dev-server</code>，它适合作为<strong>静态资源服务器</strong>，而不是<strong>开发服务器</strong>。因此，我们的开发环境除了需要 <code>webpack-dev-server</code>，还需要专门的<strong>开发服务器</strong>。</p>
<pre><code>// =&gt; Module B
// dev server
http://localhost/B/index.html
// webpack-dev-server for B
http://localhost:3001/...

// =&gt; Module C
// dev server
http://localhost/C/index.html
// webpack-dev-server for C
http://localhost:3003/...
</code></pre><p>每个模块从对应的 <code>webpack-dev-server</code> 获取资源，解决了冲突又保留了每个模块的独立性。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://apporz.com/2016/03/29/angular2-multiple-ngoninit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Micooz Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/master.portrait.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micooz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/29/angular2-multiple-ngoninit/" itemprop="url">
                  Angular2 如何多次触发子组件的 ngOnInit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-29T00:00:00+08:00">2016-03-29</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/29/angular2-multiple-ngoninit/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/03/29/angular2-multiple-ngoninit/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通常子组件加载后只会执行一次<code>ngOnInit</code>，不利于子组件的自我更新，但设法使子组件从Dom中移除后重建就可以多次触发<code>ngOnInit</code>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">person</span> *<span class="attr">ngIf</span>=<span class="string">"show"</span>&gt;</span><span class="tag">&lt;/<span class="name">person</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonComponent</span> </span>&#123;</span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="comment">// triggered if show is available</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>像这种<strong>带星号的指令</strong>就是Angular2中一种模板语法糖，可以管控组件的生命周期。</p>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/master.portrait.png" alt="Micooz Lee">
            
              <p class="site-author-name" itemprop="name">Micooz Lee</p>
              <p class="site-description motion-element" itemprop="description">FullStack JavaScript Engineer</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">50</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/micooz" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:micooz@hotmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/MicoozLee" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://instagram.com/micoozlee" target="_blank" title="Instagram"><i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://flag.moe" title="哞菇菌" target="_blank">哞菇菌</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://haipz.com" title="海胖博客" target="_blank">海胖博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.otokaze.cn" title="音風の部屋" target="_blank">音風の部屋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.anotherhome.net" title="DIYgod" target="_blank">DIYgod</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.0xbbc.com" title="BlueCocoa" target="_blank">BlueCocoa</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://windisco.com" title="ShinCurry" target="_blank">ShinCurry</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://codelover.link" title="codelover" target="_blank">codelover</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.chionlab.moe" title="ChionTang" target="_blank">ChionTang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://rakume.com/#!/home" title="Rakume Hayashi" target="_blank">Rakume Hayashi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://src.moe" title="POJO" target="_blank">POJO</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Micooz Lee</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.1.0</div>
        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  

  
    <script id="dsq-count-scr" src="https://micooz.disqus.com/count.js" async></script>
  

  





	





  












  

  <script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){var r=!1,s=0,a=0,i=n.title.trim(),c=i.toLowerCase(),l=n.content.trim().replace(/<[^>]+>/g,""),h=l.toLowerCase(),p=decodeURIComponent(n.url),u=[],f=[];if(""!=i&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}u=u.concat(e(t,c,!1)),f=f.concat(e(t,h,!1))}),(u.length>0||f.length>0)&&(r=!0,s=u.length+f.length)),r){[u,f].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});function d(e,o,n,r){for(var s=r[r.length-1],i=s.position,c=s.word,l=[],h=0;i+c.length<=n&&0!=r.length;){c===t&&h++,l.push({position:i,length:c.length});var p=i+c.length;for(r.pop();0!=r.length&&(s=r[r.length-1],i=s.position,c=s.word,p>i);)r.pop()}return a+=h,{hits:l,start:o,end:n,searchTextCount:h}}var g=[];0!=u.length&&g.push(d(0,0,i.length,u));for(var v=[];0!=f.length;){var $=f[f.length-1],C=$.position,m=$.word,x=C-20,w=C+80;x<0&&(x=0),w<C+m.length&&(w=C+m.length),w>l.length&&(w=l.length),v.push(d(0,x,w,f))}v.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var y=parseInt("1");y>=0&&(v=v.slice(0,y));function T(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var b="";0!=g.length?b+="<li><a href='"+p+"' class='search-result-title'>"+T(i,g[0])+"</a>":b+="<li><a href='"+p+"' class='search-result-title'>"+i+"</a>",v.forEach(function(t){b+="<a href='"+p+'\'><p class="search-result">'+T(l,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:a,hitCount:s,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script>





  

  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.1.0"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.1.0"></script></body></html>